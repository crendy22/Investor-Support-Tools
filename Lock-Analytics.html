<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lock Data Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            animation: slideDown 0.5s ease-out;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header-left h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .upload-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .instructions-box {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.1) 0%, rgba(68, 160, 141, 0.1) 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            border-left: 4px solid #4ECDC4;
        }

        .instructions-box h3 {
            color: #44A08D;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .instructions-box p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .support-text {
            color: #888;
            font-size: 0.95em;
            font-style: italic;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
            text-align: left;
        }

        .feature-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .feature-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }

        .feature-icon {
            font-size: 1.5em;
            margin-bottom: 8px;
            color: #4ECDC4;
        }

        .feature-title {
            color: #333;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.95em;
        }

        .feature-desc {
            color: #666;
            font-size: 0.85em;
            line-height: 1.4;
        }

        .upload-area {
            border: 3px dashed #4ECDC4;
            border-radius: 15px;
            padding: 60px 20px;
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.05) 0%, rgba(68, 160, 141, 0.05) 100%);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .upload-area:hover {
            border-color: #44A08D;
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.1) 0%, rgba(68, 160, 141, 0.1) 100%);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.2) 0%, rgba(68, 160, 141, 0.2) 100%);
            border-color: #44A08D;
        }

        .upload-icon {
            font-size: 4em;
            color: #4ECDC4;
            margin-bottom: 20px;
        }

        input[type="file"] {
            display: none;
        }

        .file-list {
            margin-top: 20px;
            text-align: left;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .file-item {
            background: white;
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .file-name {
            color: #333;
            font-weight: 500;
        }

        .file-info {
            color: #666;
            font-size: 0.9em;
        }

        .file-remove {
            color: #ff4444;
            cursor: pointer;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            transition: all 0.2s;
        }

        .file-remove:hover {
            background: rgba(255, 68, 68, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border-left: 4px solid #4ECDC4;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            color: #333;
            font-size: 1.8em;
            font-weight: bold;
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-detail {
            color: #888;
            font-size: 0.85em;
            margin-top: 5px;
        }

        /* Special cards - Status and Top Sellers */
        .special-cards-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .special-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .special-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .special-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .special-card-icon {
            font-size: 1.8em;
        }

        .special-card-title {
            color: #333;
            font-size: 1.3em;
            font-weight: 600;
        }

        /* Status Card Styles */
        .status-card {
            border-left: 4px solid #4ECDC4;
        }

        .status-main {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.1) 0%, rgba(68, 160, 141, 0.1) 100%);
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .status-main-label {
            color: #333;
            font-weight: 600;
            font-size: 1.1em;
        }

        .status-main-value {
            font-size: 2em;
            font-weight: bold;
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-main-percent {
            color: #44A08D;
            font-size: 0.9em;
            font-weight: 500;
        }

        .status-others-title {
            color: #666;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .status-others-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .status-other-item {
            background: #f8f9fa;
            padding: 10px 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .status-other-item:hover {
            background: #f0f0f0;
        }

        .status-other-item.cancelled {
            border-left: 3px solid #FF6B6B;
        }

        .status-other-item.denied {
            border-left: 3px solid #ffa502;
        }

        .status-other-item.pending {
            border-left: 3px solid #74b9ff;
        }

        .status-other-label {
            color: #555;
            font-size: 0.85em;
            font-weight: 500;
        }

        .status-other-value {
            color: #333;
            font-weight: bold;
            font-size: 1.1em;
        }

        /* Top Sellers Card Styles */
        .sellers-card {
            border-left: 4px solid #44A08D;
        }

        .sellers-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .seller-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .seller-item:hover {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.1) 0%, rgba(68, 160, 141, 0.1) 100%);
        }

        .seller-rank {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.85em;
            flex-shrink: 0;
        }

        .seller-rank.gold {
            background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);
            color: white;
        }

        .seller-rank.silver {
            background: linear-gradient(135deg, #bdc3c7 0%, #95a5a6 100%);
            color: white;
        }

        .seller-rank.bronze {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            color: white;
        }

        .seller-rank.other {
            background: #e0e0e0;
            color: #666;
        }

        .seller-info {
            flex: 1;
            min-width: 0;
        }

        .seller-name {
            color: #333;
            font-weight: 500;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .seller-bar-container {
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            margin-top: 5px;
            overflow: hidden;
        }

        .seller-bar {
            height: 100%;
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        .seller-count {
            font-weight: bold;
            color: #44A08D;
            font-size: 1em;
            flex-shrink: 0;
        }

        .filters-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            position: relative;
        }

        .filter-label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-select {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            font-size: 0.95em;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: #4ECDC4;
            box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.2);
        }

        .range-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .range-input, .date-input {
            flex: 1;
            min-width: 0;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            font-size: 0.95em;
            transition: all 0.3s ease;
        }

        .range-input:focus, .date-input:focus {
            outline: none;
            border-color: #44A08D;
            box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.2);
        }

        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(78, 205, 196, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #4ECDC4;
            border: 2px solid #4ECDC4;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.1) 0%, rgba(68, 160, 141, 0.1) 100%);
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(67, 233, 123, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(67, 233, 123, 0.4);
        }

        .btn-pdf {
            background: linear-gradient(135deg, #FF6B6B 0%, #ee5a5a 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }

        .btn-pdf:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .data-table-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .summary-info {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.1) 0%, rgba(68, 160, 141, 0.1) 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .summary-info h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .summary-stats {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .summary-stat {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-stat-label {
            color: #666;
            font-weight: 600;
        }

        .summary-stat-value {
            color: #44A08D;
            font-weight: bold;
            font-size: 1.2em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th {
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        tr:hover {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.05) 0%, rgba(68, 160, 141, 0.05) 100%);
        }

        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            height: 400px;
            position: relative;
        }

        .chart-container.tall {
            height: 450px;
        }

        .chart-title {
            color: #333;
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .chart-wrapper {
            position: relative;
            height: calc(100% - 50px);
            width: 100%;
        }

        .hidden {
            display: none !important;
        }

        .date-info {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            font-size: 1.1em;
        }

        .date-info span {
            color: #44A08D;
            font-weight: 600;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #e0e0e0;
            border-top-color: #4ECDC4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            color: #333;
            font-size: 1.2em;
            font-weight: 500;
        }

        .section-title {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .section-title h2 {
            color: #333;
            font-size: 1.5em;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title h2::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
            border-radius: 2px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .filter-grid, .stats-grid {
                grid-template-columns: 1fr;
            }

            .charts-section {
                grid-template-columns: 1fr;
            }

            .special-cards-row {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                text-align: center;
            }

            .header-left h1 {
                font-size: 1.8em;
            }

            .features-grid {
                grid-template-columns: 1fr;
            }
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .chart-container {
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>üîí Lock Data Analytics Dashboard</h1>
                <p class="subtitle">Upload monthly lock reports to analyze and slice data across multiple dimensions</p>
            </div>
            <div class="header-actions hidden" id="headerActions">
                <button class="btn btn-pdf" onclick="exportToPDF()">üìÑ Export Charts to PDF</button>
                <button class="btn btn-secondary" onclick="resetDashboard()">üîÑ New Analysis</button>
            </div>
        </div>

        <div class="upload-section" id="uploadSection">
            <div class="instructions-box">
                <h3>üìã Getting Started</h3>
                <p>Please upload monthly lock report(s) in order to run analysis. You can upload a single file or multiple files (up to 10) for comprehensive multi-month analysis.</p>
                <p class="support-text">Please contact support@loannex.com if you experience any issues.</p>
            </div>

            <div class="upload-area" onclick="document.getElementById('fileInput').click();" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                <div class="upload-icon">üìä</div>
                <h2>Upload Lock Reports</h2>
                <p>Click to browse or drag and drop your Excel files here</p>
                <p style="margin-top: 10px; color: #888; font-size: 0.9em;">Supports .xlsx and .xls files (up to 10 files)</p>
                <input type="file" id="fileInput" accept=".xlsx,.xls" multiple onchange="handleFileSelect(event)">
            </div>

            <div class="features-grid">
                <div class="feature-item">
                    <div class="feature-icon">üìà</div>
                    <div class="feature-title">Trend Analysis</div>
                    <div class="feature-desc">Identify patterns in rates, loan amounts, and LTV ratios across time periods</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">üè¢</div>
                    <div class="feature-title">Seller Tracking</div>
                    <div class="feature-desc">Track unique seller activity month-over-month</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">üó∫Ô∏è</div>
                    <div class="feature-title">Geographic Insights</div>
                    <div class="feature-desc">Analyze loan distribution across all 50 states with interactive visualizations</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">üí∞</div>
                    <div class="feature-title">Performance Metrics</div>
                    <div class="feature-desc">Track purchase vs refinance trends, program breakdown, and more</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">üìÑ</div>
                    <div class="feature-title">PDF Export</div>
                    <div class="feature-desc">Export all charts to a professional PDF report</div>
                </div>
            </div>

            <div class="file-list" id="fileList"></div>
            <div class="btn-group" id="processButtons" style="display: none;">
                <button class="btn btn-success" onclick="processAllFiles()">Process All Files</button>
                <button class="btn btn-secondary" onclick="clearFiles()">Clear Files</button>
            </div>
        </div>

        <div id="dateInfo" class="date-info hidden"></div>

        <div id="statsSection" class="hidden">
            <div class="stats-grid" id="statsGrid"></div>
        </div>

        <!-- Special Cards: Status and Top Sellers -->
        <div id="specialCardsSection" class="special-cards-row hidden">
            <div class="special-card status-card" id="statusCard">
                <div class="special-card-header">
                    <span class="special-card-icon">üìä</span>
                    <span class="special-card-title">Lock Status Breakdown</span>
                </div>
                <div id="statusContent"></div>
            </div>
            <div class="special-card sellers-card" id="topSellersCard">
                <div class="special-card-header">
                    <span class="special-card-icon">üèÜ</span>
                    <span class="special-card-title">Top 10 Sellers by Lock Volume</span>
                </div>
                <div id="topSellersContent"></div>
            </div>
        </div>

        <div id="filtersSection" class="filters-section hidden">
            <h2 style="margin-bottom: 20px; color: #333;">üéØ Filter Data</h2>
            <div class="filter-grid" id="filterGrid"></div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                <button class="btn btn-secondary" onclick="resetFilters()">Reset All</button>
                <button class="btn btn-secondary" onclick="exportFilteredData()">üì• Export to Excel</button>
            </div>
        </div>

        <div id="chartsContainer" class="hidden">
            <div class="section-title">
                <h2>Monthly Trends</h2>
            </div>
            <div class="charts-section" id="trendChartsSection"></div>

            <div class="section-title">
                <h2>Distribution Analysis</h2>
            </div>
            <div class="charts-section" id="distributionChartsSection"></div>

            <div class="section-title">
                <h2>Geographic & Rate Analysis</h2>
            </div>
            <div class="charts-section" id="geoChartsSection"></div>
        </div>

        <div id="tableSection" class="data-table-section hidden">
            <div class="summary-info">
                <h3>üìä Filtered Results Summary</h3>
                <div class="summary-stats" id="summaryStats"></div>
            </div>
            <div id="tableContainer"></div>
        </div>
    </div>

    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Processing files...</div>
    </div>

    <script>
        // Global variables
        let rawData = [];
        let filteredData = [];
        let charts = {};
        let activeFilters = {};
        let uploadedFiles = [];

        // Column mappings - adjust these if column names differ
        const COLUMNS = {
            seller: 'Originator Dba Name',
            lockDate: 'Lock Approved Date',
            purpose: 'Purpose',
            program: 'Program',
            loanType: 'Loan Type',
            state: 'State',
            rate: 'Final Rate',
            loanAmount: 'LoanAmount',
            ltv: 'LTV',
            lockId: 'NexId',
            mortgageProduct: 'MortgageProduct',
            status: 'Status'
        };

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard initialized successfully');
        });

        function showLoading(text = 'Processing...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            addFiles(files);
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            addFiles(files);
        }

        function addFiles(files) {
            const excelFiles = files.filter(file => 
                file.name.endsWith('.xlsx') || file.name.endsWith('.xls')
            );

            if (uploadedFiles.length + excelFiles.length > 10) {
                alert('Maximum 10 files allowed');
                return;
            }

            excelFiles.forEach(file => {
                if (!uploadedFiles.find(f => f.name === file.name)) {
                    uploadedFiles.push(file);
                }
            });

            updateFileList();
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            const processButtons = document.getElementById('processButtons');
            
            if (uploadedFiles.length === 0) {
                fileList.innerHTML = '';
                processButtons.style.display = 'none';
                return;
            }

            processButtons.style.display = 'flex';
            
            let html = '';
            uploadedFiles.forEach((file, index) => {
                html += `<div class="file-item">
                    <div>
                        <div class="file-name">${file.name}</div>
                        <div class="file-info">${(file.size / 1024).toFixed(1)} KB</div>
                    </div>
                    <span class="file-remove" onclick="removeFile(${index})">√ó</span>
                </div>`;
            });
            fileList.innerHTML = html;
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            updateFileList();
        }

        function clearFiles() {
            uploadedFiles = [];
            updateFileList();
        }

        function processAllFiles() {
            if (uploadedFiles.length === 0) {
                alert('Please upload at least one file');
                return;
            }

            showLoading('Processing files...');
            rawData = [];
            let processedCount = 0;

            uploadedFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const fileData = XLSX.utils.sheet_to_json(worksheet, { raw: false, dateNF: 'yyyy-mm-dd' });
                        
                        if (fileData.length > 0) {
                            rawData = rawData.concat(fileData);
                        }
                        
                        processedCount++;
                        if (processedCount === uploadedFiles.length) {
                            onAllFilesProcessed();
                        }
                    } catch (error) {
                        console.error('Error reading file:', error);
                        alert('Error reading file: ' + error.message);
                        processedCount++;
                        if (processedCount === uploadedFiles.length) {
                            onAllFilesProcessed();
                        }
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function onAllFilesProcessed() {
            if (rawData.length === 0) {
                hideLoading();
                alert('No data found in the uploaded files');
                return;
            }

            processData();
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('headerActions').classList.remove('hidden');
            hideLoading();
        }

        function processData() {
            filteredData = [...rawData];
            
            displayDateRange();
            displayInitialStats();
            displayStatusCard();
            displayTopSellersCard();
            setupFilters();
            displayAllCharts();
            displayTable();
            
            // Show all sections
            document.getElementById('statsSection').classList.remove('hidden');
            document.getElementById('specialCardsSection').classList.remove('hidden');
            document.getElementById('filtersSection').classList.remove('hidden');
            document.getElementById('chartsContainer').classList.remove('hidden');
            document.getElementById('tableSection').classList.remove('hidden');
        }

        function displayDateRange() {
            const dateInfo = document.getElementById('dateInfo');
            const dates = filteredData
                .map(row => parseDate(row[COLUMNS.lockDate]))
                .filter(d => d !== null)
                .sort((a, b) => a - b);
            
            if (dates.length > 0) {
                const minDate = dates[0];
                const maxDate = dates[dates.length - 1];
                dateInfo.innerHTML = `üìÖ Data Range: <span>${formatDate(minDate)}</span> to <span>${formatDate(maxDate)}</span> | <span>${filteredData.length.toLocaleString()}</span> total locks`;
                dateInfo.classList.remove('hidden');
            }
        }

        function displayInitialStats() {
            const statsGrid = document.getElementById('statsGrid');
            const stats = calculateStats(filteredData);
            
            const statCards = [
                { label: 'Total Locks', value: stats.totalLocks.toLocaleString(), detail: 'Total records' },
                { label: 'Unique Sellers', value: stats.uniqueSellers.toLocaleString(), detail: 'Active originators' },
                { label: 'Purchase', value: stats.purchasePercent + '%', detail: stats.purchaseCount.toLocaleString() + ' locks' },
                { label: 'Refinance', value: stats.refiPercent + '%', detail: stats.refiCount.toLocaleString() + ' locks' },
                { label: 'Avg Rate', value: stats.avgRate + '%', detail: 'Interest rate' },
                { label: 'Avg Loan', value: '$' + stats.avgLoanAmount, detail: 'Loan amount' }
            ];
            
            let html = '';
            statCards.forEach(stat => {
                html += `<div class="stat-card">
                    <div class="stat-label">${stat.label}</div>
                    <div class="stat-value">${stat.value}</div>
                    <div class="stat-detail">${stat.detail}</div>
                </div>`;
            });
            
            statsGrid.innerHTML = html;
        }

        function displayStatusCard() {
            const statusContent = document.getElementById('statusContent');
            const statusCounts = getValueCounts(filteredData, COLUMNS.status);
            
            // Sort by count descending
            const sorted = Object.entries(statusCounts).sort((a, b) => b[1] - a[1]);
            const total = sorted.reduce((sum, [_, count]) => sum + count, 0);
            
            // Find Lock Approved (main status)
            const lockApprovedEntry = sorted.find(([status]) => status === 'Lock Approved');
            const lockApprovedCount = lockApprovedEntry ? lockApprovedEntry[1] : 0;
            const lockApprovedPercent = total > 0 ? ((lockApprovedCount / total) * 100).toFixed(1) : 0;
            
            // Other statuses
            const otherStatuses = sorted.filter(([status]) => status !== 'Lock Approved');
            
            let html = `
                <div class="status-main">
                    <div>
                        <div class="status-main-label">‚úÖ Lock Approved</div>
                        <div class="status-main-percent">${lockApprovedPercent}% of total</div>
                    </div>
                    <div class="status-main-value">${lockApprovedCount.toLocaleString()}</div>
                </div>
            `;
            
            if (otherStatuses.length > 0) {
                html += `<div class="status-others-title">Other Statuses</div>`;
                html += `<div class="status-others-grid">`;
                
                otherStatuses.forEach(([status, count]) => {
                    let itemClass = 'status-other-item';
                    if (status.toLowerCase().includes('cancel')) itemClass += ' cancelled';
                    else if (status.toLowerCase().includes('denied')) itemClass += ' denied';
                    else itemClass += ' pending';
                    
                    const displayStatus = status.length > 18 ? status.substring(0, 16) + '...' : status;
                    
                    html += `
                        <div class="${itemClass}" title="${status}">
                            <span class="status-other-label">${displayStatus}</span>
                            <span class="status-other-value">${count.toLocaleString()}</span>
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            statusContent.innerHTML = html;
        }

        function displayTopSellersCard() {
            const topSellersContent = document.getElementById('topSellersContent');
            const sellerCounts = getValueCounts(filteredData, COLUMNS.seller);
            
            // Sort by count and take top 10
            const sorted = Object.entries(sellerCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const maxCount = sorted.length > 0 ? sorted[0][1] : 1;
            
            let html = '<div class="sellers-list">';
            
            sorted.forEach(([seller, count], index) => {
                let rankClass = 'other';
                if (index === 0) rankClass = 'gold';
                else if (index === 1) rankClass = 'silver';
                else if (index === 2) rankClass = 'bronze';
                
                const barWidth = (count / maxCount) * 100;
                const displayName = seller.length > 35 ? seller.substring(0, 33) + '...' : seller;
                
                html += `
                    <div class="seller-item" title="${seller}">
                        <div class="seller-rank ${rankClass}">${index + 1}</div>
                        <div class="seller-info">
                            <div class="seller-name">${displayName}</div>
                            <div class="seller-bar-container">
                                <div class="seller-bar" style="width: ${barWidth}%"></div>
                            </div>
                        </div>
                        <div class="seller-count">${count.toLocaleString()}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            topSellersContent.innerHTML = html;
        }

        function calculateStats(data) {
            const stats = {
                totalLocks: data.length,
                uniqueSellers: new Set(data.map(row => row[COLUMNS.seller]).filter(Boolean)).size,
                purchaseCount: 0,
                refiCount: 0,
                rates: [],
                loanAmounts: [],
                ltvs: []
            };

            data.forEach(row => {
                const purpose = row[COLUMNS.purpose];
                if (purpose === 'Purchase') stats.purchaseCount++;
                else if (purpose === 'CashOutRefinance' || purpose === 'NoCashOutRefinance') stats.refiCount++;

                const rate = parseFloat(row[COLUMNS.rate]);
                const loanAmount = parseFloat(row[COLUMNS.loanAmount]);
                const ltv = parseFloat(row[COLUMNS.ltv]);

                if (!isNaN(rate)) stats.rates.push(rate);
                if (!isNaN(loanAmount)) stats.loanAmounts.push(loanAmount);
                if (!isNaN(ltv)) stats.ltvs.push(ltv);
            });

            stats.purchasePercent = stats.totalLocks > 0 ? ((stats.purchaseCount / stats.totalLocks) * 100).toFixed(1) : 0;
            stats.refiPercent = stats.totalLocks > 0 ? ((stats.refiCount / stats.totalLocks) * 100).toFixed(1) : 0;
            stats.avgRate = stats.rates.length > 0 ? (stats.rates.reduce((a, b) => a + b, 0) / stats.rates.length).toFixed(3) : 0;
            stats.avgLoanAmount = stats.loanAmounts.length > 0 ? 
                Math.round(stats.loanAmounts.reduce((a, b) => a + b, 0) / stats.loanAmounts.length).toLocaleString() : 0;
            stats.avgLTV = stats.ltvs.length > 0 ? ((stats.ltvs.reduce((a, b) => a + b, 0) / stats.ltvs.length) * 100).toFixed(1) : 0;

            return stats;
        }

        function setupFilters() {
            const filterGrid = document.getElementById('filterGrid');
            
            // Get unique values for each filter dimension
            const purposes = [...new Set(filteredData.map(r => r[COLUMNS.purpose]).filter(Boolean))].sort();
            const programs = [...new Set(filteredData.map(r => r[COLUMNS.program]).filter(Boolean))].sort();
            const loanTypes = [...new Set(filteredData.map(r => r[COLUMNS.loanType]).filter(Boolean))].sort();
            const states = [...new Set(filteredData.map(r => r[COLUMNS.state]).filter(Boolean))].sort();
            const sellers = [...new Set(filteredData.map(r => r[COLUMNS.seller]).filter(Boolean))].sort();
            const statuses = [...new Set(filteredData.map(r => r[COLUMNS.status]).filter(Boolean))].sort();

            filterGrid.innerHTML = `
                <div class="filter-group">
                    <label class="filter-label">Purpose</label>
                    <select class="filter-select" id="filterPurpose">
                        <option value="">All Purposes</option>
                        ${purposes.map(p => `<option value="${p}">${p}</option>`).join('')}
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Program</label>
                    <select class="filter-select" id="filterProgram">
                        <option value="">All Programs</option>
                        ${programs.map(p => `<option value="${p}">${p}</option>`).join('')}
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Loan Type</label>
                    <select class="filter-select" id="filterLoanType">
                        <option value="">All Loan Types</option>
                        ${loanTypes.map(t => `<option value="${t}">${t}</option>`).join('')}
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">State</label>
                    <select class="filter-select" id="filterState">
                        <option value="">All States</option>
                        ${states.map(s => `<option value="${s}">${s}</option>`).join('')}
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Seller</label>
                    <select class="filter-select" id="filterSeller">
                        <option value="">All Sellers</option>
                        ${sellers.map(s => `<option value="${s}">${s}</option>`).join('')}
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Status</label>
                    <select class="filter-select" id="filterStatus">
                        <option value="">All Statuses</option>
                        ${statuses.map(s => `<option value="${s}">${s}</option>`).join('')}
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Date Range</label>
                    <div class="range-input-group">
                        <input type="date" class="date-input" id="filterDateFrom" placeholder="From">
                        <span>to</span>
                        <input type="date" class="date-input" id="filterDateTo" placeholder="To">
                    </div>
                </div>
            `;
        }

        function displayAllCharts() {
            // Destroy existing charts
            Object.values(charts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            charts = {};

            const trendSection = document.getElementById('trendChartsSection');
            const distributionSection = document.getElementById('distributionChartsSection');
            const geoSection = document.getElementById('geoChartsSection');

            trendSection.innerHTML = '';
            distributionSection.innerHTML = '';
            geoSection.innerHTML = '';

            // --- TREND CHARTS ---

            // 1. Unique Sellers Per Month Chart
            const sellersContainer = createChartContainer('Unique Sellers Per Month', 'sellersChart');
            trendSection.appendChild(sellersContainer);
            createUniqueSellersChart();

            // 2. Locks Per Month Chart
            const locksContainer = createChartContainer('Total Locks Per Month', 'locksChart');
            trendSection.appendChild(locksContainer);
            createLocksPerMonthChart();

            // 3. Fixed vs ARM Monthly Trend
            const fixedArmContainer = createChartContainer('Fixed vs ARM Locks - Monthly Trend', 'fixedArmChart');
            trendSection.appendChild(fixedArmContainer);
            createFixedArmChart();

            // --- DISTRIBUTION CHARTS ---

            // 4. Loan Purpose Breakdown
            const purposeContainer = createChartContainer('Loan Purpose Breakdown', 'purposeChart');
            distributionSection.appendChild(purposeContainer);
            createPurposeChart();

            // 5. Program Breakdown
            const programContainer = createChartContainer('Program Breakdown', 'programChart');
            distributionSection.appendChild(programContainer);
            createProgramChart();

            // 6. Loan Type Breakdown
            const loanTypeContainer = createChartContainer('Loan Type Breakdown', 'loanTypeChart');
            distributionSection.appendChild(loanTypeContainer);
            createLoanTypeChart();

            // --- GEO & RATE CHARTS ---

            // 7. Top States Chart
            const stateContainer = createChartContainer('Top 10 States by Lock Volume', 'stateChart');
            geoSection.appendChild(stateContainer);
            createStateChart();

            // 8. Rate Distribution Chart
            const rateContainer = createChartContainer('Interest Rate Distribution', 'rateChart');
            geoSection.appendChild(rateContainer);
            createRateChart();
        }

        function createChartContainer(title, chartId) {
            const container = document.createElement('div');
            container.className = 'chart-container';
            container.id = chartId + 'Container';
            container.innerHTML = `<h3 class="chart-title">${title}</h3><div class="chart-wrapper"><canvas id="${chartId}"></canvas></div>`;
            return container;
        }

        // Chart creation functions
        function createUniqueSellersChart() {
            const ctx = document.getElementById('sellersChart').getContext('2d');
            const monthlyData = processSellersPerMonth(filteredData);
            
            charts.sellers = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthlyData.labels,
                    datasets: [{
                        label: 'Unique Sellers',
                        data: monthlyData.counts,
                        backgroundColor: 'rgba(78, 205, 196, 0.7)',
                        borderColor: '#4ECDC4',
                        borderWidth: 2,
                        borderRadius: 8,
                        barThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    return monthlyData.sellerNames[context.dataIndex].slice(0, 5).join(', ') + 
                                           (monthlyData.sellerNames[context.dataIndex].length > 5 ? '...' : '');
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Unique Sellers',
                                font: { weight: 'bold' }
                            },
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Month',
                                font: { weight: 'bold' }
                            }
                        }
                    }
                }
            });
        }

        function createLocksPerMonthChart() {
            const ctx = document.getElementById('locksChart').getContext('2d');
            const monthlyData = processLocksPerMonth(filteredData);
            
            charts.locks = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthlyData.labels,
                    datasets: [{
                        label: 'Total Locks',
                        data: monthlyData.counts,
                        backgroundColor: 'rgba(68, 160, 141, 0.2)',
                        borderColor: '#44A08D',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointBackgroundColor: '#44A08D'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Locks',
                                font: { weight: 'bold' }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Month',
                                font: { weight: 'bold' }
                            }
                        }
                    }
                }
            });
        }

        function createFixedArmChart() {
            const ctx = document.getElementById('fixedArmChart').getContext('2d');
            const monthlyData = processFixedArmByMonth(filteredData);
            
            charts.fixedArm = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthlyData.labels,
                    datasets: [
                        {
                            label: 'Fixed Rate',
                            data: monthlyData.fixed,
                            backgroundColor: 'rgba(78, 205, 196, 0.8)',
                            borderColor: '#4ECDC4',
                            borderWidth: 1,
                            borderRadius: 4
                        },
                        {
                            label: 'ARM',
                            data: monthlyData.arm,
                            backgroundColor: 'rgba(68, 160, 141, 0.8)',
                            borderColor: '#44A08D',
                            borderWidth: 1,
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: false },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Locks',
                                font: { weight: 'bold' }
                            }
                        }
                    },
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });
        }

        function createPurposeChart() {
            const ctx = document.getElementById('purposeChart').getContext('2d');
            const purposeCounts = getValueCounts(filteredData, COLUMNS.purpose);
            
            charts.purpose = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(purposeCounts),
                    datasets: [{
                        data: Object.values(purposeCounts),
                        backgroundColor: [
                            '#4ECDC4',
                            '#44A08D',
                            '#43e97b',
                            '#38f9d7',
                            '#4facfe'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, font: { size: 12 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createProgramChart() {
            const ctx = document.getElementById('programChart').getContext('2d');
            const programCounts = getValueCounts(filteredData, COLUMNS.program);
            
            // Sort by count and take top entries
            const sorted = Object.entries(programCounts).sort((a, b) => b[1] - a[1]);
            
            charts.program = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(s => truncateLabel(s[0], 25)),
                    datasets: [{
                        label: 'Number of Locks',
                        data: sorted.map(s => s[1]),
                        backgroundColor: generateGradientColors(sorted.length),
                        borderColor: '#44A08D',
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return sorted[context[0].dataIndex][0];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Locks',
                                font: { weight: 'bold' }
                            }
                        }
                    }
                }
            });
        }

        function createLoanTypeChart() {
            const ctx = document.getElementById('loanTypeChart').getContext('2d');
            const loanTypeCounts = getValueCounts(filteredData, COLUMNS.loanType);
            
            charts.loanType = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(loanTypeCounts),
                    datasets: [{
                        data: Object.values(loanTypeCounts),
                        backgroundColor: [
                            '#4ECDC4',
                            '#FF6B6B',
                            '#43e97b',
                            '#4facfe',
                            '#f093fb'
                        ],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, font: { size: 12 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createStateChart() {
            const ctx = document.getElementById('stateChart').getContext('2d');
            const stateCounts = getValueCounts(filteredData, COLUMNS.state);
            const topStates = Object.entries(stateCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            charts.state = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topStates.map(s => s[0]),
                    datasets: [{
                        label: 'Number of Locks',
                        data: topStates.map(s => s[1]),
                        backgroundColor: 'rgba(68, 160, 141, 0.7)',
                        borderColor: '#44A08D',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Locks',
                                font: { weight: 'bold' }
                            }
                        }
                    }
                }
            });
        }

        function createRateChart() {
            const ctx = document.getElementById('rateChart').getContext('2d');
            const rates = filteredData.map(row => parseFloat(row[COLUMNS.rate])).filter(r => !isNaN(r));
            const rateBins = createHistogramBins(rates, 12);
            
            charts.rate = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: rateBins.labels,
                    datasets: [{
                        label: 'Number of Locks',
                        data: rateBins.counts,
                        backgroundColor: 'rgba(78, 205, 196, 0.7)',
                        borderColor: '#4ECDC4',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Locks',
                                font: { weight: 'bold' }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Interest Rate (%)',
                                font: { weight: 'bold' }
                            }
                        }
                    }
                }
            });
        }

        // Data processing functions
        function processSellersPerMonth(data) {
            const monthlyData = {};
            
            data.forEach(row => {
                const lockDate = parseDate(row[COLUMNS.lockDate]);
                if (!lockDate) return;
                
                const monthKey = formatMonthYear(lockDate);
                const seller = row[COLUMNS.seller];
                
                if (!seller) return;
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = new Set();
                }
                monthlyData[monthKey].add(seller);
            });
            
            // Sort by date
            const sortedMonths = Object.keys(monthlyData).sort((a, b) => {
                return parseMonthYear(a) - parseMonthYear(b);
            });
            
            return {
                labels: sortedMonths,
                counts: sortedMonths.map(m => monthlyData[m].size),
                sellerNames: sortedMonths.map(m => Array.from(monthlyData[m]))
            };
        }

        function processLocksPerMonth(data) {
            const monthlyData = {};
            
            data.forEach(row => {
                const lockDate = parseDate(row[COLUMNS.lockDate]);
                if (!lockDate) return;
                
                const monthKey = formatMonthYear(lockDate);
                monthlyData[monthKey] = (monthlyData[monthKey] || 0) + 1;
            });
            
            const sortedMonths = Object.keys(monthlyData).sort((a, b) => {
                return parseMonthYear(a) - parseMonthYear(b);
            });
            
            return {
                labels: sortedMonths,
                counts: sortedMonths.map(m => monthlyData[m])
            };
        }

        function processFixedArmByMonth(data) {
            const monthlyStats = {};
            
            data.forEach(row => {
                const lockDate = parseDate(row[COLUMNS.lockDate]);
                if (!lockDate) return;
                
                const monthKey = formatMonthYear(lockDate);
                if (!monthlyStats[monthKey]) {
                    monthlyStats[monthKey] = { fixed: 0, arm: 0 };
                }
                
                const productType = row[COLUMNS.mortgageProduct] || '';
                const isARM = productType.toString().toUpperCase().includes('ARM') || 
                              productType.toString().includes('/') ||
                              productType.toString().toUpperCase().includes('ADJUSTABLE');
                
                if (isARM) {
                    monthlyStats[monthKey].arm++;
                } else {
                    monthlyStats[monthKey].fixed++;
                }
            });
            
            const sortedMonths = Object.keys(monthlyStats).sort((a, b) => {
                return parseMonthYear(a) - parseMonthYear(b);
            });
            
            return {
                labels: sortedMonths,
                fixed: sortedMonths.map(m => monthlyStats[m].fixed),
                arm: sortedMonths.map(m => monthlyStats[m].arm)
            };
        }

        function getValueCounts(data, column) {
            const counts = {};
            data.forEach(row => {
                const value = row[column] || 'Unknown';
                counts[value] = (counts[value] || 0) + 1;
            });
            return counts;
        }

        // Utility functions
        function parseDate(dateValue) {
            if (!dateValue) return null;
            
            if (dateValue instanceof Date) {
                return dateValue;
            }
            
            if (typeof dateValue === 'number' && dateValue > 25000 && dateValue < 50000) {
                return new Date((dateValue - 25569) * 86400 * 1000);
            }
            
            const parsed = new Date(dateValue);
            if (!isNaN(parsed.getTime())) {
                return parsed;
            }
            
            return null;
        }

        function formatDate(date) {
            if (!date) return '-';
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function formatMonthYear(date) {
            if (!date || !(date instanceof Date)) return '-';
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return months[date.getMonth()] + ' ' + date.getFullYear();
        }

        function parseMonthYear(str) {
            const months = { 'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5, 
                           'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11 };
            const parts = str.split(' ');
            return new Date(parseInt(parts[1]), months[parts[0]], 1);
        }

        function truncateLabel(label, maxLength) {
            if (label.length <= maxLength) return label;
            return label.substring(0, maxLength - 3) + '...';
        }

        function generateGradientColors(count) {
            const colors = [];
            for (let i = 0; i < count; i++) {
                const ratio = i / count;
                const r = Math.round(78 + (68 - 78) * ratio);
                const g = Math.round(205 + (160 - 205) * ratio);
                const b = Math.round(196 + (141 - 196) * ratio);
                colors.push(`rgba(${r}, ${g}, ${b}, 0.8)`);
            }
            return colors;
        }

        function createHistogramBins(data, binCount) {
            if (data.length === 0) return { labels: [], counts: [] };
            
            const min = Math.min(...data);
            const max = Math.max(...data);
            const binSize = (max - min) / binCount;
            
            const bins = Array(binCount).fill(0);
            const labels = [];
            
            for (let i = 0; i < binCount; i++) {
                const binMin = min + i * binSize;
                const binMax = min + (i + 1) * binSize;
                labels.push(binMin.toFixed(2) + '-' + binMax.toFixed(2));
                
                data.forEach(value => {
                    if (value >= binMin && (value < binMax || (i === binCount - 1 && value === max))) {
                        bins[i]++;
                    }
                });
            }
            
            return { labels, counts: bins };
        }

        function displayTable() {
            const tableContainer = document.getElementById('tableContainer');
            const displayData = filteredData.slice(0, 100);
            
            let html = `<p style="margin-bottom: 15px; color: #666;">Showing ${displayData.length} of ${filteredData.length.toLocaleString()} records</p>`;
            html += `<table>
                <thead>
                    <tr>
                        <th>Lock ID</th>
                        <th>Seller</th>
                        <th>Lock Date</th>
                        <th>Status</th>
                        <th>State</th>
                        <th>Purpose</th>
                        <th>Program</th>
                        <th>Rate</th>
                        <th>Loan Amount</th>
                    </tr>
                </thead>
                <tbody>`;
            
            displayData.forEach(row => {
                const lockDate = parseDate(row[COLUMNS.lockDate]);
                html += `<tr>
                    <td>${row[COLUMNS.lockId] || '-'}</td>
                    <td>${truncateLabel(row[COLUMNS.seller] || '-', 30)}</td>
                    <td>${lockDate ? formatDate(lockDate) : '-'}</td>
                    <td>${row[COLUMNS.status] || '-'}</td>
                    <td>${row[COLUMNS.state] || '-'}</td>
                    <td>${row[COLUMNS.purpose] || '-'}</td>
                    <td>${truncateLabel(row[COLUMNS.program] || '-', 25)}</td>
                    <td>${row[COLUMNS.rate] || '-'}</td>
                    <td>${row[COLUMNS.loanAmount] ? '$' + parseFloat(row[COLUMNS.loanAmount]).toLocaleString() : '-'}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            tableContainer.innerHTML = html;
            
            updateSummaryStats();
        }

        function updateSummaryStats() {
            const summaryStats = document.getElementById('summaryStats');
            const stats = calculateStats(filteredData);
            
            summaryStats.innerHTML = `
                <div class="summary-stat">
                    <span class="summary-stat-label">Total Records:</span>
                    <span class="summary-stat-value">${stats.totalLocks.toLocaleString()}</span>
                </div>
                <div class="summary-stat">
                    <span class="summary-stat-label">Unique Sellers:</span>
                    <span class="summary-stat-value">${stats.uniqueSellers}</span>
                </div>
                <div class="summary-stat">
                    <span class="summary-stat-label">Avg Rate:</span>
                    <span class="summary-stat-value">${stats.avgRate}%</span>
                </div>
                <div class="summary-stat">
                    <span class="summary-stat-label">Avg Loan:</span>
                    <span class="summary-stat-value">$${stats.avgLoanAmount}</span>
                </div>
            `;
        }

        function applyFilters() {
            showLoading('Applying filters...');
            
            setTimeout(() => {
                const purposeFilter = document.getElementById('filterPurpose').value;
                const programFilter = document.getElementById('filterProgram').value;
                const loanTypeFilter = document.getElementById('filterLoanType').value;
                const stateFilter = document.getElementById('filterState').value;
                const sellerFilter = document.getElementById('filterSeller').value;
                const statusFilter = document.getElementById('filterStatus').value;
                const dateFrom = document.getElementById('filterDateFrom').value;
                const dateTo = document.getElementById('filterDateTo').value;
                
                filteredData = rawData.filter(row => {
                    if (purposeFilter && row[COLUMNS.purpose] !== purposeFilter) return false;
                    if (programFilter && row[COLUMNS.program] !== programFilter) return false;
                    if (loanTypeFilter && row[COLUMNS.loanType] !== loanTypeFilter) return false;
                    if (stateFilter && row[COLUMNS.state] !== stateFilter) return false;
                    if (sellerFilter && row[COLUMNS.seller] !== sellerFilter) return false;
                    if (statusFilter && row[COLUMNS.status] !== statusFilter) return false;
                    
                    if (dateFrom || dateTo) {
                        const lockDate = parseDate(row[COLUMNS.lockDate]);
                        if (!lockDate) return false;
                        
                        if (dateFrom && lockDate < new Date(dateFrom)) return false;
                        if (dateTo && lockDate > new Date(dateTo + 'T23:59:59')) return false;
                    }
                    
                    return true;
                });
                
                displayDateRange();
                displayInitialStats();
                displayStatusCard();
                displayTopSellersCard();
                displayAllCharts();
                displayTable();
                hideLoading();
            }, 100);
        }

        function resetFilters() {
            document.getElementById('filterPurpose').value = '';
            document.getElementById('filterProgram').value = '';
            document.getElementById('filterLoanType').value = '';
            document.getElementById('filterState').value = '';
            document.getElementById('filterSeller').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            
            filteredData = [...rawData];
            displayDateRange();
            displayInitialStats();
            displayStatusCard();
            displayTopSellersCard();
            displayAllCharts();
            displayTable();
        }

        function exportFilteredData() {
            if (filteredData.length === 0) {
                alert('No data to export');
                return;
            }

            showLoading('Preparing Excel export...');
            
            setTimeout(() => {
                const ws = XLSX.utils.json_to_sheet(filteredData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Filtered Data');
                XLSX.writeFile(wb, 'filtered_lock_data.xlsx');
                hideLoading();
            }, 100);
        }

        async function exportToPDF() {
            showLoading('Generating PDF report...');
            
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('landscape', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 15;
                
                // PDF compression settings
                const imageScale = 1.2;  // Reduced from 2 - still crisp but much smaller
                const imageQuality = 0.7; // JPEG quality (0.0 to 1.0)
                const imageFormat = 'JPEG'; // JPEG compresses much better than PNG
                
                // Title page
                pdf.setFillColor(78, 205, 196);
                pdf.rect(0, 0, pageWidth, 40, 'F');
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(28);
                pdf.text('Lock Data Analytics Report', pageWidth / 2, 25, { align: 'center' });
                
                pdf.setTextColor(51, 51, 51);
                pdf.setFontSize(12);
                const today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                pdf.text(`Generated: ${today}`, pageWidth / 2, 55, { align: 'center' });
                pdf.text(`Total Records: ${filteredData.length.toLocaleString()}`, pageWidth / 2, 65, { align: 'center' });
                
                const stats = calculateStats(filteredData);
                pdf.text(`Unique Sellers: ${stats.uniqueSellers} | Avg Rate: ${stats.avgRate}% | Avg Loan: $${stats.avgLoanAmount}`, pageWidth / 2, 75, { align: 'center' });

                // Helper function to capture and add image with compression
                async function captureAndAddImage(element, yOffset = 25) {
                    const canvas = await html2canvas(element, {
                        scale: imageScale,
                        backgroundColor: '#ffffff',
                        logging: false,
                        useCORS: true
                    });
                    
                    // Convert to JPEG with compression
                    const imgData = canvas.toDataURL('image/jpeg', imageQuality);
                    const imgWidth = pageWidth - (margin * 2);
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    const maxHeight = pageHeight - 40;
                    
                    const finalHeight = Math.min(imgHeight, maxHeight);
                    const finalWidth = (finalHeight === maxHeight) ? (canvas.width * finalHeight) / canvas.height : imgWidth;
                    
                    const xPos = (pageWidth - finalWidth) / 2;
                    pdf.addImage(imgData, imageFormat, xPos, yOffset, finalWidth, finalHeight, undefined, 'FAST');
                }

                // Add Status and Top Sellers cards
                pdf.addPage();
                pdf.setFillColor(78, 205, 196);
                pdf.rect(0, 0, pageWidth, 20, 'F');
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(16);
                pdf.text('Status & Top Sellers Overview', pageWidth / 2, 13, { align: 'center' });

                const specialCardsSection = document.getElementById('specialCardsSection');
                if (specialCardsSection) {
                    await captureAndAddImage(specialCardsSection);
                }
                
                // Chart containers to capture
                const chartConfigs = [
                    { id: 'sellersChartContainer', title: 'Unique Sellers Per Month' },
                    { id: 'locksChartContainer', title: 'Total Locks Per Month' },
                    { id: 'fixedArmChartContainer', title: 'Fixed vs ARM Locks' },
                    { id: 'purposeChartContainer', title: 'Loan Purpose Breakdown' },
                    { id: 'programChartContainer', title: 'Program Breakdown' },
                    { id: 'loanTypeChartContainer', title: 'Loan Type Breakdown' },
                    { id: 'stateChartContainer', title: 'Top 10 States' },
                    { id: 'rateChartContainer', title: 'Interest Rate Distribution' }
                ];
                
                for (let i = 0; i < chartConfigs.length; i++) {
                    const config = chartConfigs[i];
                    const element = document.getElementById(config.id);
                    
                    if (element) {
                        pdf.addPage();
                        
                        // Page header
                        pdf.setFillColor(78, 205, 196);
                        pdf.rect(0, 0, pageWidth, 20, 'F');
                        pdf.setTextColor(255, 255, 255);
                        pdf.setFontSize(16);
                        pdf.text(config.title, pageWidth / 2, 13, { align: 'center' });
                        
                        // Capture chart with compression
                        await captureAndAddImage(element);
                    }
                }
                
                // Save PDF
                pdf.save('lock_analytics_report.pdf');
                hideLoading();
                
            } catch (error) {
                console.error('PDF export error:', error);
                hideLoading();
                alert('Error generating PDF. Please try again.');
            }
        }

        function resetDashboard() {
            if (confirm('Start a new analysis? This will clear all current data.')) {
                location.reload();
            }
        }

        console.log('Lock Data Analytics Dashboard v3.0 loaded successfully!');
    </script>
</body>
</html>
