<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lock Data Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .upload-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .instructions-box {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.1) 0%, rgba(68, 160, 141, 0.1) 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            border-left: 4px solid #4ECDC4;
        }

        .instructions-box h3 {
            color: #44A08D;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .instructions-box p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .support-text {
            color: #888;
            font-size: 0.95em;
            font-style: italic;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
            text-align: left;
        }

        .feature-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .feature-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }

        .feature-icon {
            font-size: 1.5em;
            margin-bottom: 8px;
            color: #4ECDC4;
        }

        .feature-title {
            color: #333;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.95em;
        }

        .feature-desc {
            color: #666;
            font-size: 0.85em;
            line-height: 1.4;
        }

        .upload-area {
            border: 3px dashed #4ECDC4;
            border-radius: 15px;
            padding: 60px 20px;
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.05) 0%, rgba(68, 160, 141, 0.05) 100%);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .upload-area:hover {
            border-color: #44A08D;
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.1) 0%, rgba(68, 160, 141, 0.1) 100%);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.2) 0%, rgba(68, 160, 141, 0.2) 100%);
            border-color: #44A08D;
        }

        .upload-icon {
            font-size: 4em;
            color: #4ECDC4;
            margin-bottom: 20px;
        }

        input[type="file"] {
            display: none;
        }

        .file-list {
            margin-top: 20px;
            text-align: left;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .file-item {
            background: white;
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .file-name {
            color: #333;
            font-weight: 500;
        }

        .file-info {
            color: #666;
            font-size: 0.9em;
        }

        .file-remove {
            color: #ff4444;
            cursor: pointer;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            transition: all 0.2s;
        }

        .file-remove:hover {
            background: rgba(255, 68, 68, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border-left: 4px solid #4ECDC4;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            color: #333;
            font-size: 1.8em;
            font-weight: bold;
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-detail {
            color: #888;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .filters-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            position: relative;
        }

        .filter-label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .multi-select-container {
            position: relative;
        }

        .multi-select-display {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 42px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
        }

        .multi-select-display:hover {
            border-color: #4ECDC4;
        }

        .multi-select-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #4ECDC4;
            border-radius: 10px;
            margin-top: 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .multi-select-dropdown.show {
            display: block;
            animation: dropDown 0.2s ease-out;
        }

        @keyframes dropDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .multi-select-option {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .multi-select-option:hover {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.1) 0%, rgba(68, 160, 141, 0.1) 100%);
        }

        .multi-select-option.selected {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.2) 0%, rgba(68, 160, 141, 0.2) 100%);
        }

        .multi-select-option input[type="checkbox"] {
            accent-color: #4ECDC4;
        }

        .selected-tag {
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.85em;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .selected-tag .remove {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .selected-tag .remove:hover {
            opacity: 1;
        }

        .range-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .range-input, .date-input {
            flex: 1;
            min-width: 0;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            font-size: 0.95em;
            transition: all 0.3s ease;
        }

        .range-input:focus, .date-input:focus {
            outline: none;
            border-color: #44A08D;
            box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.2);
        }

        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(78, 205, 196, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #4ECDC4;
            border: 2px solid #4ECDC4;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.1) 0%, rgba(68, 160, 141, 0.1) 100%);
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(67, 233, 123, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(67, 233, 123, 0.4);
        }

        .data-table-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .summary-info {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.1) 0%, rgba(68, 160, 141, 0.1) 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .summary-info h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .summary-stats {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .summary-stat {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-stat-label {
            color: #666;
            font-weight: 600;
        }

        .summary-stat-value {
            color: #44A08D;
            font-weight: bold;
            font-size: 1.2em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th {
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        tr:hover {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.05) 0%, rgba(68, 160, 141, 0.05) 100%);
        }

        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            height: 400px;
            position: relative;
        }

        .chart-title {
            color: #333;
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .chart-wrapper {
            position: relative;
            height: calc(100% - 50px);
            width: 100%;
        }

        .hidden {
            display: none !important;
        }

        .date-info {
            background: rgba(78, 205, 196, 0.1);
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .filter-grid, .stats-grid {
                grid-template-columns: 1fr;
            }

            .charts-section {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.8em;
            }

            .features-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîí Lock Data Analytics Dashboard</h1>
            <p class="subtitle">Upload multiple monthly lock reports to analyze and slice data across multiple dimensions</p>
        </div>

        <div class="upload-section" id="uploadSection">
            <div class="instructions-box">
                <h3>üìã Getting Started</h3>
                <p>Please upload monthly lock report(s) in order to run analysis. You can upload a single file or multiple files (up to 10) for comprehensive multi-month analysis.</p>
                <p class="support-text">Please contact support@loannex.com if you experience any issues.</p>
            </div>

            <div class="upload-area" onclick="document.getElementById('fileInput').click();" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                <div class="upload-icon">üìä</div>
                <h2>Upload Lock Reports</h2>
                <p>Click to browse or drag and drop your Excel files here</p>
                <p style="margin-top: 10px; color: #888; font-size: 0.9em;">Supports .xlsx and .xls files (up to 10 files)</p>
                <input type="file" id="fileInput" accept=".xlsx,.xls" multiple onchange="handleFileSelect(event)">
            </div>

            <div class="features-grid">
                <div class="feature-item">
                    <div class="feature-icon">üìà</div>
                    <div class="feature-title">Trend Analysis</div>
                    <div class="feature-desc">Identify patterns in rates, loan amounts, and LTV ratios across time periods</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">üéØ</div>
                    <div class="feature-title">Smart Filtering</div>
                    <div class="feature-desc">Slice data by 17+ dimensions including investor, product, state, and date ranges</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">üó∫Ô∏è</div>
                    <div class="feature-title">Geographic Insights</div>
                    <div class="feature-desc">Analyze loan distribution across all 50 states with interactive visualizations</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">üí∞</div>
                    <div class="feature-title">Performance Metrics</div>
                    <div class="feature-desc">Track purchase vs refinance trends, first-time buyer percentages, and more</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">üìä</div>
                    <div class="feature-title">Export Reports</div>
                    <div class="feature-desc">Download filtered data to Excel for further analysis and sharing</div>
                </div>
            </div>

            <div class="file-list" id="fileList"></div>
            <div class="btn-group" id="processButtons" style="display: none;">
                <button class="btn btn-success" onclick="processAllFiles()">Process All Files</button>
                <button class="btn btn-secondary" onclick="clearFiles()">Clear Files</button>
            </div>
        </div>

        <div id="dateInfo" class="date-info hidden"></div>

        <div id="statsSection" class="hidden">
            <div class="stats-grid" id="statsGrid"></div>
        </div>

        <div id="filtersSection" class="filters-section hidden">
            <h2 style="margin-bottom: 20px; color: #333;">Filter Data</h2>
            <div class="filter-grid" id="filterGrid"></div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                <button class="btn btn-secondary" onclick="resetFilters()">Reset All</button>
                <button class="btn btn-secondary" onclick="exportFilteredData()">Export to Excel</button>
            </div>
        </div>

        <div id="chartsSection" class="charts-section hidden"></div>

        <div id="tableSection" class="data-table-section hidden">
            <div class="summary-info">
                <h3>Filtered Results Summary</h3>
                <div class="summary-stats" id="summaryStats"></div>
            </div>
            <div id="tableContainer"></div>
        </div>
    </div>

    <script>
        // Global variables
        let rawData = [];
        let filteredData = [];
        let charts = {};
        let activeFilters = {};
        let uploadedFiles = [];

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard initialized successfully');
        });

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            addFiles(files);
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            addFiles(files);
        }

        function addFiles(files) {
            const excelFiles = files.filter(file => 
                file.name.endsWith('.xlsx') || file.name.endsWith('.xls')
            );

            if (uploadedFiles.length + excelFiles.length > 10) {
                alert('Maximum 10 files allowed');
                return;
            }

            excelFiles.forEach(file => {
                if (!uploadedFiles.find(f => f.name === file.name)) {
                    uploadedFiles.push(file);
                }
            });

            updateFileList();
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            const processButtons = document.getElementById('processButtons');
            
            if (uploadedFiles.length === 0) {
                fileList.innerHTML = '';
                processButtons.style.display = 'none';
                return;
            }

            processButtons.style.display = 'flex';
            
            let html = '';
            uploadedFiles.forEach((file, index) => {
                html += '<div class="file-item">' +
                    '<div>' +
                    '<div class="file-name">' + file.name + '</div>' +
                    '<div class="file-info">' + (file.size / 1024).toFixed(1) + ' KB</div>' +
                    '</div>' +
                    '<span class="file-remove" onclick="removeFile(' + index + ')">√ó</span>' +
                    '</div>';
            });
            fileList.innerHTML = html;
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            updateFileList();
        }

        function clearFiles() {
            uploadedFiles = [];
            updateFileList();
        }

        function processAllFiles() {
            if (uploadedFiles.length === 0) {
                alert('Please upload at least one file');
                return;
            }

            rawData = [];
            let processedCount = 0;

            uploadedFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const fileData = XLSX.utils.sheet_to_json(worksheet);
                        
                        if (fileData.length > 0) {
                            rawData = rawData.concat(fileData);
                        }
                        
                        processedCount++;
                        if (processedCount === uploadedFiles.length) {
                            onAllFilesProcessed();
                        }
                    } catch (error) {
                        alert('Error reading file: ' + error.message);
                        processedCount++;
                        if (processedCount === uploadedFiles.length) {
                            onAllFilesProcessed();
                        }
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function onAllFilesProcessed() {
            if (rawData.length === 0) {
                alert('No data found in the uploaded files');
                return;
            }

            processData();
            document.getElementById('uploadSection').style.display = 'none';
        }

        function processData() {
            filteredData = [...rawData];
            
            displayInitialStats();
            setupFilters();
            displayCharts();
            displayTable();
            
            // Show all sections
            document.getElementById('statsSection').classList.remove('hidden');
            document.getElementById('filtersSection').classList.remove('hidden');
            document.getElementById('chartsSection').classList.remove('hidden');
            document.getElementById('tableSection').classList.remove('hidden');
        }

        function displayInitialStats() {
            const statsGrid = document.getElementById('statsGrid');
            const stats = calculateStats(rawData);
            
            let html = '';
            const statCards = [
                { label: 'Total Locks', value: stats.totalLocks.toLocaleString(), detail: 'Total records' },
                { label: 'Purchase', value: stats.purchasePercent + '%', detail: stats.purchaseCount.toLocaleString() + ' locks' },
                { label: 'Refinance', value: stats.refiPercent + '%', detail: stats.refiCount.toLocaleString() + ' locks' },
                { label: 'Avg Rate', value: stats.avgRate + '%', detail: 'Interest rate' },
                { label: 'Avg Loan', value: '$' + stats.avgLoanAmount, detail: 'Loan amount' },
                { label: 'Avg LTV', value: stats.avgLTV + '%', detail: 'Loan to value' }
            ];
            
            statCards.forEach(stat => {
                html += '<div class="stat-card">' +
                    '<div class="stat-label">' + stat.label + '</div>' +
                    '<div class="stat-value">' + stat.value + '</div>' +
                    '<div class="stat-detail">' + stat.detail + '</div>' +
                    '</div>';
            });
            
            statsGrid.innerHTML = html;
        }

        function calculateStats(data) {
            const stats = {
                totalLocks: data.length,
                purchaseCount: 0,
                refiCount: 0,
                rates: [],
                loanAmounts: [],
                ltvs: []
            };

            data.forEach(row => {
                if (row.Purpose === 'Purchase') stats.purchaseCount++;
                else if (row.Purpose === 'CashOutRefinance' || row.Purpose === 'NoCashOutRefinance') stats.refiCount++;

                const rate = parseFloat(row['Final Rate'] || row.Rate);
                const loanAmount = parseFloat(row.LoanAmount);
                const ltv = parseFloat(row.LTV);

                if (!isNaN(rate)) stats.rates.push(rate);
                if (!isNaN(loanAmount)) stats.loanAmounts.push(loanAmount);
                if (!isNaN(ltv)) stats.ltvs.push(ltv);
            });

            stats.purchasePercent = stats.totalLocks > 0 ? ((stats.purchaseCount / stats.totalLocks) * 100).toFixed(1) : 0;
            stats.refiPercent = stats.totalLocks > 0 ? ((stats.refiCount / stats.totalLocks) * 100).toFixed(1) : 0;
            stats.avgRate = stats.rates.length > 0 ? (stats.rates.reduce((a, b) => a + b, 0) / stats.rates.length).toFixed(3) : 0;
            stats.avgLoanAmount = stats.loanAmounts.length > 0 ? 
                Math.round(stats.loanAmounts.reduce((a, b) => a + b, 0) / stats.loanAmounts.length).toLocaleString() : 0;
            stats.avgLTV = stats.ltvs.length > 0 ? ((stats.ltvs.reduce((a, b) => a + b, 0) / stats.ltvs.length) * 100).toFixed(1) : 0;

            return stats;
        }

        function setupFilters() {
            // Simplified filter setup - will be populated after data is loaded
            const filterGrid = document.getElementById('filterGrid');
            filterGrid.innerHTML = '<p style="color: #666;">Filters will appear here after data is loaded</p>';
        }

        function displayCharts() {
            const chartsSection = document.getElementById('chartsSection');
            chartsSection.innerHTML = '';

            // Destroy existing charts
            Object.values(charts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            charts = {};

            // Fixed vs ARM Monthly Trend Chart
            const fixedArmContainer = createChartContainer('Fixed vs ARM Locks - Monthly Trend');
            chartsSection.appendChild(fixedArmContainer);
            const fixedArmCanvas = fixedArmContainer.querySelector('canvas');
            const fixedArmCtx = fixedArmCanvas.getContext('2d');
            
            // Process Fixed vs ARM data by month
            const monthlyData = processFixedArmByMonth(filteredData);
            
            charts.fixedArm = new Chart(fixedArmCtx, {
                type: 'bar',
                data: {
                    labels: monthlyData.labels,
                    datasets: [
                        {
                            label: 'Fixed Rate',
                            data: monthlyData.fixed,
                            backgroundColor: '#4ECDC4',
                            borderColor: '#44A08D',
                            borderWidth: 1
                        },
                        {
                            label: 'ARM',
                            data: monthlyData.arm,
                            backgroundColor: '#44A08D',
                            borderColor: '#4ECDC4',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: false
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Locks'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const total = monthlyData.fixed[context.dataIndex] + monthlyData.arm[context.dataIndex];
                                    const percentage = ((context.parsed.y / total) * 100).toFixed(1);
                                    return percentage + '% of total';
                                }
                            }
                        }
                    }
                }
            });

            // Purpose Distribution Chart
            const purposeContainer = createChartContainer('Purpose Distribution');
            chartsSection.appendChild(purposeContainer);
            const purposeCanvas = purposeContainer.querySelector('canvas');
            const purposeCtx = purposeCanvas.getContext('2d');
            
            const purposeCounts = {};
            filteredData.forEach(row => {
                const purpose = row.Purpose || 'Unknown';
                purposeCounts[purpose] = (purposeCounts[purpose] || 0) + 1;
            });

            charts.purpose = new Chart(purposeCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(purposeCounts),
                    datasets: [{
                        data: Object.values(purposeCounts),
                        backgroundColor: [
                            '#4ECDC4',
                            '#44A08D',
                            '#43e97b',
                            '#38f9d7',
                            '#4facfe'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 10,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });

            // Rate Distribution Chart
            const rateContainer = createChartContainer('Rate Distribution');
            chartsSection.appendChild(rateContainer);
            const rateCanvas = rateContainer.querySelector('canvas');
            const rateCtx = rateCanvas.getContext('2d');
            
            const rates = filteredData.map(row => parseFloat(row['Final Rate'] || row['Note Rate'])).filter(r => !isNaN(r));
            const rateBins = createHistogramBins(rates, 10);
            
            charts.rate = new Chart(rateCtx, {
                type: 'bar',
                data: {
                    labels: rateBins.labels,
                    datasets: [{
                        label: 'Number of Locks',
                        data: rateBins.counts,
                        backgroundColor: 'rgba(78, 205, 196, 0.7)',
                        borderColor: '#4ECDC4',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Top States Chart
            const stateContainer = createChartContainer('Top 10 States');
            chartsSection.appendChild(stateContainer);
            const stateCanvas = stateContainer.querySelector('canvas');
            const stateCtx = stateCanvas.getContext('2d');
            
            const stateCounts = {};
            filteredData.forEach(row => {
                const state = row.State || row['Property State'] || 'Unknown';
                stateCounts[state] = (stateCounts[state] || 0) + 1;
            });
            
            const topStates = Object.entries(stateCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            charts.state = new Chart(stateCtx, {
                type: 'bar',
                data: {
                    labels: topStates.map(s => s[0]),
                    datasets: [{
                        label: 'Number of Locks',
                        data: topStates.map(s => s[1]),
                        backgroundColor: 'rgba(68, 160, 141, 0.7)',
                        borderColor: '#44A08D',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function processFixedArmByMonth(data) {
            const monthlyStats = {};
            const today = new Date();
            
            // Initialize last 12 months
            for (let i = 11; i >= 0; i--) {
                const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const key = formatMonthYear(date);
                monthlyStats[key] = { fixed: 0, arm: 0, total: 0 };
            }
            
            // Process data
            data.forEach(row => {
                // Get date from appropriate column
                let lockDate = null;
                
                // Try different date columns
                const dateFields = ['Lock Date', 'Lock Requested', 'Last Request Date', 'Created Date', 'Date'];
                for (let field of dateFields) {
                    if (row[field]) {
                        lockDate = parseDate(row[field]);
                        if (lockDate) break;
                    }
                }
                
                if (!lockDate) return;
                
                const monthKey = formatMonthYear(lockDate);
                if (!monthlyStats[monthKey]) return;
                
                // Check if Fixed or ARM
                const productType = row['Product Type'] || row['Mortgage Product'] || row['MortgageProduct'] || row['Product'] || '';
                const isARM = productType.toString().toUpperCase().includes('ARM') || 
                              productType.toString().includes('/') ||
                              productType.toString().toUpperCase().includes('ADJUSTABLE');
                
                if (isARM) {
                    monthlyStats[monthKey].arm++;
                } else {
                    monthlyStats[monthKey].fixed++;
                }
                monthlyStats[monthKey].total++;
            });
            
            // Format for Chart.js
            const labels = Object.keys(monthlyStats);
            const fixed = labels.map(label => monthlyStats[label].fixed);
            const arm = labels.map(label => monthlyStats[label].arm);
            
            return { labels, fixed, arm };
        }

        function parseDate(dateValue) {
            if (!dateValue) return null;
            
            // Handle Excel serial date
            if (typeof dateValue === 'number' && dateValue > 25000 && dateValue < 50000) {
                // Excel date serial number
                return new Date((dateValue - 25569) * 86400 * 1000);
            }
            
            // Handle date object
            if (dateValue instanceof Date) {
                return dateValue;
            }
            
            // Handle string date
            const parsed = new Date(dateValue);
            if (!isNaN(parsed.getTime())) {
                return parsed;
            }
            
            return null;
        }

        function formatMonthYear(date) {
            if (!date || !(date instanceof Date)) return '-';
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return months[date.getMonth()] + ' ' + date.getFullYear();
        }

        function createChartContainer(title) {
            const container = document.createElement('div');
            container.className = 'chart-container';
            container.innerHTML = '<h3 class="chart-title">' + title + '</h3><div class="chart-wrapper"><canvas></canvas></div>';
            return container;
        }

        function createHistogramBins(data, binCount) {
            if (data.length === 0) return { labels: [], counts: [] };
            
            const min = Math.min(...data);
            const max = Math.max(...data);
            const binSize = (max - min) / binCount;
            
            const bins = Array(binCount).fill(0);
            const labels = [];
            
            for (let i = 0; i < binCount; i++) {
                const binMin = min + i * binSize;
                const binMax = min + (i + 1) * binSize;
                labels.push(binMin.toFixed(2) + '-' + binMax.toFixed(2));
                
                data.forEach(value => {
                    if (value >= binMin && value < binMax) {
                        bins[i]++;
                    } else if (i === binCount - 1 && value === max) {
                        bins[i]++;
                    }
                });
            }
            
            return { labels: labels, counts: bins };
        }

        function displayTable() {
            const tableContainer = document.getElementById('tableContainer');
            const displayData = filteredData.slice(0, 100);
            
            let html = '<p>Showing ' + displayData.length + ' of ' + filteredData.length + ' records</p>';
            html += '<table><thead><tr><th>Lock ID</th><th>State</th><th>Purpose</th><th>Rate</th><th>Loan Amount</th></tr></thead><tbody>';
            
            displayData.forEach(row => {
                html += '<tr>' +
                    '<td>' + (row.NexId || row['Lock Number'] || '-') + '</td>' +
                    '<td>' + (row.State || '-') + '</td>' +
                    '<td>' + (row.Purpose || '-') + '</td>' +
                    '<td>' + (row['Final Rate'] || '-') + '</td>' +
                    '<td>' + (row.LoanAmount ? '$' + parseFloat(row.LoanAmount).toLocaleString() : '-') + '</td>' +
                    '</tr>';
            });
            
            html += '</tbody></table>';
            tableContainer.innerHTML = html;
        }

        function updateSummaryStats() {
            const summaryStats = document.getElementById('summaryStats');
            const stats = calculateStats(filteredData);
            summaryStats.innerHTML = '<div class="summary-stat">' +
                '<span class="summary-stat-label">Total Records:</span>' +
                '<span class="summary-stat-value">' + stats.totalLocks.toLocaleString() + '</span>' +
                '</div>';
        }

        function applyFilters() {
            // Simplified filter application
            displayCharts();
            displayTable();
            updateSummaryStats();
        }

        function resetFilters() {
            filteredData = [...rawData];
            displayCharts();
            displayTable();
            updateSummaryStats();
        }

        function exportFilteredData() {
            if (filteredData.length === 0) {
                alert('No data to export');
                return;
            }

            const ws = XLSX.utils.json_to_sheet(filteredData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Filtered Data');
            XLSX.writeFile(wb, 'filtered_lock_data.xlsx');
        }

        console.log('Lock Data Analytics Dashboard loaded successfully!');
    </script>
</body>
</html>
