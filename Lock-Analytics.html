<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lock Data Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; }
        .header { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px; margin-bottom: 30px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .header-left h1 { color: #333; font-size: 2.5em; margin-bottom: 10px; background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle { color: #666; font-size: 1.1em; }
        .header-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .upload-section { background: rgba(255, 255, 255, 0.95); padding: 40px; border-radius: 20px; margin-bottom: 30px; text-align: center; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); }
        .instructions-box { background: linear-gradient(135deg, rgba(78, 205, 196, 0.1) 0%, rgba(68, 160, 141, 0.1) 100%); padding: 20px; border-radius: 15px; margin-bottom: 30px; border-left: 4px solid #4ECDC4; }
        .instructions-box h3 { color: #44A08D; margin-bottom: 10px; }
        .instructions-box p { color: #666; line-height: 1.6; margin-bottom: 10px; }
        .upload-area { border: 3px dashed #4ECDC4; border-radius: 15px; padding: 60px 20px; background: linear-gradient(135deg, rgba(78, 205, 196, 0.05) 0%, rgba(68, 160, 141, 0.05) 100%); cursor: pointer; transition: all 0.3s ease; }
        .upload-area:hover { border-color: #44A08D; background: linear-gradient(135deg, rgba(78, 205, 196, 0.1) 0%, rgba(68, 160, 141, 0.1) 100%); }
        .upload-icon { font-size: 4em; color: #4ECDC4; margin-bottom: 20px; }
        input[type="file"] { display: none; }
        .file-list { margin-top: 20px; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto; }
        .file-item { background: white; padding: 12px 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }
        .file-name { color: #333; font-weight: 500; }
        .file-remove { color: #ff4444; cursor: pointer; font-weight: bold; padding: 5px 10px; }
        .primary-filters { background: rgba(255, 255, 255, 0.95); padding: 25px 30px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); border-left: 5px solid #4ECDC4; }
        .primary-filters h2 { color: #333; font-size: 1.3em; margin-bottom: 20px; }
        .primary-filter-grid { display: grid; grid-template-columns: 1fr 1fr auto; gap: 20px; align-items: end; }
        .primary-filter-group label { display: block; color: #333; font-weight: 600; margin-bottom: 8px; }
        .primary-filter-select { width: 100%; padding: 12px 15px; border: 2px solid #4ECDC4; border-radius: 10px; background: white; font-size: 1em; }
        .searchable-dropdown { position: relative; width: 100%; }
        .searchable-dropdown-input { width: 100%; padding: 12px 40px 12px 15px; border: 2px solid #4ECDC4; border-radius: 10px; background: white; font-size: 1em; }
        .searchable-dropdown-list { position: absolute; top: 100%; left: 0; right: 0; max-height: 300px; overflow-y: auto; background: white; border: 2px solid #4ECDC4; border-top: none; border-radius: 0 0 10px 10px; z-index: 1000; display: none; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15); }
        .searchable-dropdown-list.show { display: block; }
        .searchable-dropdown-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .searchable-dropdown-item:hover { background: rgba(78, 205, 196, 0.1); }
        .searchable-dropdown-item.selected { background: rgba(78, 205, 196, 0.2); font-weight: 600; }
        .searchable-dropdown-item-count { color: #44A08D; font-size: 0.85em; float: right; }
        .searchable-dropdown-clear { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #999; font-size: 1.2em; cursor: pointer; }
        .context-banner { background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%); color: white; padding: 12px 20px; border-radius: 10px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
        .context-banner-text { font-weight: 500; font-size: 1.05em; }
        .context-banner-clear { background: rgba(255, 255, 255, 0.2); border: none; color: white; padding: 6px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; }
        .overview-section { background: rgba(255, 255, 255, 0.95); padding: 25px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); border-left: 5px solid #44A08D; }
        .overview-title { font-size: 1.4em; color: #333; font-weight: 600; }
        .overview-subtitle { color: #666; font-size: 0.95em; margin-top: 5px; margin-bottom: 20px; }
        .overview-cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; }
        .overview-card { background: #f8f9fa; padding: 15px; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent; }
        .overview-card:hover { background: rgba(78, 205, 196, 0.1); border-color: #4ECDC4; transform: translateY(-2px); }
        .overview-card.selected { background: rgba(78, 205, 196, 0.2); border-color: #44A08D; }
        .overview-card-name { font-weight: 600; color: #333; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .overview-card-stats { display: flex; justify-content: space-between; font-size: 0.85em; }
        .overview-card-locks { color: #44A08D; font-weight: bold; }
        .overview-card-secondary { color: #666; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: rgba(255, 255, 255, 0.95); padding: 20px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); border-left: 4px solid #4ECDC4; }
        .stat-label { color: #666; font-size: 0.9em; margin-bottom: 5px; text-transform: uppercase; }
        .stat-value { color: #333; font-size: 1.8em; font-weight: bold; background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stat-detail { color: #888; font-size: 0.85em; margin-top: 5px; }
        .special-cards-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .special-card { background: rgba(255, 255, 255, 0.95); padding: 25px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); }
        .special-card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0; }
        .special-card-icon { font-size: 1.8em; }
        .special-card-title { color: #333; font-size: 1.3em; font-weight: 600; }
        .special-card-context { color: #44A08D; font-size: 0.85em; margin-left: auto; background: rgba(78, 205, 196, 0.1); padding: 4px 10px; border-radius: 12px; }
        .status-card { border-left: 4px solid #4ECDC4; }
        .status-main { display: flex; align-items: center; justify-content: space-between; background: rgba(78, 205, 196, 0.1); padding: 15px 20px; border-radius: 12px; margin-bottom: 15px; }
        .status-main-label { color: #333; font-weight: 600; font-size: 1.1em; }
        .status-main-value { font-size: 2em; font-weight: bold; background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .status-main-percent { color: #44A08D; font-size: 0.9em; }
        .status-others-title { color: #666; font-size: 0.85em; text-transform: uppercase; margin-bottom: 10px; }
        .status-others-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
        .status-other-item { background: #f8f9fa; padding: 10px 12px; border-radius: 8px; display: flex; justify-content: space-between; }
        .status-other-item.cancelled { border-left: 3px solid #FF6B6B; }
        .status-other-item.pending { border-left: 3px solid #74b9ff; }
        .status-other-label { color: #555; font-size: 0.85em; }
        .status-other-value { color: #333; font-weight: bold; }
        .leaderboard-card { border-left: 4px solid #44A08D; }
        .leaderboard-list { display: flex; flex-direction: column; gap: 8px; }
        .leaderboard-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; background: #f8f9fa; border-radius: 8px; }
        .leaderboard-rank { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.85em; }
        .leaderboard-rank.gold { background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%); color: white; }
        .leaderboard-rank.silver { background: linear-gradient(135deg, #bdc3c7 0%, #95a5a6 100%); color: white; }
        .leaderboard-rank.bronze { background: linear-gradient(135deg, #e67e22 0%, #d35400 100%); color: white; }
        .leaderboard-rank.other { background: #e0e0e0; color: #666; }
        .leaderboard-info { flex: 1; min-width: 0; }
        .leaderboard-name { color: #333; font-weight: 500; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .leaderboard-bar-container { height: 4px; background: #e0e0e0; border-radius: 2px; margin-top: 5px; }
        .leaderboard-bar { height: 100%; background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%); border-radius: 2px; }
        .leaderboard-count { font-weight: bold; color: #44A08D; }
        .filters-section { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px; margin-bottom: 30px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .filter-label { display: block; color: #333; font-weight: 600; margin-bottom: 8px; font-size: 0.9em; text-transform: uppercase; }
        .filter-select { width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 10px; background: white; font-size: 0.95em; }
        .range-input-group { display: flex; gap: 10px; align-items: center; }
        .date-input { flex: 1; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 10px; background: white; }
        .btn-group { display: flex; gap: 15px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        .btn { padding: 12px 30px; border: none; border-radius: 10px; font-size: 1em; font-weight: 600; cursor: pointer; text-transform: uppercase; }
        .btn-primary { background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%); color: white; }
        .btn-secondary { background: white; color: #4ECDC4; border: 2px solid #4ECDC4; }
        .btn-success { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; }
        .btn-pdf { background: linear-gradient(135deg, #FF6B6B 0%, #ee5a5a 100%); color: white; }
        .data-table-section { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px; margin-bottom: 30px; overflow-x: auto; }
        .summary-info { background: rgba(78, 205, 196, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .summary-stats { display: flex; gap: 30px; flex-wrap: wrap; }
        .summary-stat { display: flex; align-items: center; gap: 10px; }
        .summary-stat-label { color: #666; font-weight: 600; }
        .summary-stat-value { color: #44A08D; font-weight: bold; font-size: 1.2em; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%); color: white; padding: 15px; text-align: left; }
        td { padding: 12px 15px; border-bottom: 1px solid #e0e0e0; }
        tr:hover { background: rgba(78, 205, 196, 0.05); }
        .charts-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 30px; margin-bottom: 30px; }
        .chart-container { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); height: 400px; }
        .chart-title { color: #333; font-size: 1.3em; font-weight: 600; margin-bottom: 20px; text-align: center; }
        .chart-subtitle { color: #666; font-size: 0.9em; text-align: center; margin-top: -15px; margin-bottom: 15px; }
        .chart-wrapper { position: relative; height: calc(100% - 50px); width: 100%; }
        .hidden { display: none !important; }
        .date-info { background: rgba(255, 255, 255, 0.95); padding: 15px 25px; border-radius: 15px; margin-bottom: 20px; color: #333; text-align: center; }
        .date-info span { color: #44A08D; font-weight: 600; }
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .loading-spinner { width: 60px; height: 60px; border: 4px solid #e0e0e0; border-top-color: #4ECDC4; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 20px; color: #333; font-size: 1.2em; }
        .section-title { background: rgba(255, 255, 255, 0.95); padding: 20px 30px; border-radius: 15px; margin-bottom: 20px; }
        .section-title h2 { color: #333; font-size: 1.5em; display: flex; align-items: center; gap: 10px; }
        .section-title h2::before { content: ''; width: 4px; height: 24px; background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%); border-radius: 2px; }
        @media (max-width: 768px) { .primary-filter-grid, .filter-grid, .stats-grid, .charts-section, .special-cards-row { grid-template-columns: 1fr; } .header { flex-direction: column; text-align: center; } .header-left h1 { font-size: 1.8em; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>üîí Lock Data Analytics Dashboard</h1>
                <p class="subtitle">Upload monthly lock reports to analyze and slice data across buyers, sellers, and multiple dimensions</p>
            </div>
            <div class="header-actions hidden" id="headerActions">
                <button class="btn btn-pdf" onclick="exportToPDF()">üìÑ Export to PDF</button>
                <button class="btn btn-secondary" onclick="resetDashboard()">üîÑ New Analysis</button>
            </div>
        </div>
        <div class="upload-section" id="uploadSection">
            <div class="instructions-box">
                <h3>üìã Getting Started</h3>
                <p>Upload monthly lock report(s) to run analysis. You can upload multiple files (up to 10).</p>
            </div>
            <div class="upload-area" onclick="document.getElementById('fileInput').click();" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                <div class="upload-icon">üìä</div>
                <h2>Upload Lock Reports</h2>
                <p>Click to browse or drag and drop Excel files here</p>
                <input type="file" id="fileInput" accept=".xlsx,.xls" multiple onchange="handleFileSelect(event)">
            </div>
            <div class="file-list" id="fileList"></div>
            <div class="btn-group" id="processButtons" style="display: none;">
                <button class="btn btn-success" onclick="processAllFiles()">Process All Files</button>
                <button class="btn btn-secondary" onclick="clearFiles()">Clear Files</button>
            </div>
        </div>
        <div id="contextBanner" class="context-banner hidden">
            <span class="context-banner-text" id="contextBannerText"></span>
            <button class="context-banner-clear" onclick="clearPrimaryFilters()">‚úï Clear Selection</button>
        </div>
        <div id="primaryFilters" class="primary-filters hidden">
            <h2>üéØ Filter by Buyer & Seller</h2>
            <div class="primary-filter-grid">
                <div class="primary-filter-group">
                    <label>Buyer (Investor / Lender)</label>
                    <select class="primary-filter-select" id="buyerFilter" onchange="onBuyerChange()"><option value="">All Buyers</option></select>
                </div>
                <div class="primary-filter-group">
                    <label>Seller (Originator)</label>
                    <div class="searchable-dropdown" id="sellerDropdown">
                        <input type="text" class="searchable-dropdown-input" id="sellerSearchInput" placeholder="Search sellers..." onclick="toggleSellerDropdown(true)" oninput="filterSellerList()" onfocus="toggleSellerDropdown(true)">
                        <button class="searchable-dropdown-clear" onclick="clearSellerSelection(event)" style="display:none;" id="sellerClearBtn">&times;</button>
                        <div class="searchable-dropdown-list" id="sellerDropdownList"></div>
                    </div>
                </div>
                <div><button class="btn btn-primary" onclick="applyPrimaryFilters()">Apply</button></div>
            </div>
        </div>
        <div id="overviewSection" class="overview-section hidden">
            <div class="overview-title" id="overviewTitle">üìä Buyer Overview</div>
            <div class="overview-subtitle" id="overviewSubtitle">Click a card to filter, or use the dropdown above</div>
            <div class="overview-cards-grid" id="overviewCardsGrid"></div>
        </div>
        <div id="dateInfo" class="date-info hidden"></div>
        <div id="statsSection" class="hidden"><div class="stats-grid" id="statsGrid"></div></div>
        <div id="specialCardsSection" class="special-cards-row hidden">
            <div class="special-card status-card">
                <div class="special-card-header"><span class="special-card-icon">üìä</span><span class="special-card-title">Lock Status Breakdown</span><span class="special-card-context" id="statusContext"></span></div>
                <div id="statusContent"></div>
            </div>
            <div class="special-card leaderboard-card">
                <div class="special-card-header"><span class="special-card-icon">üèÜ</span><span class="special-card-title" id="leaderboardTitle">Top 10 Sellers</span><span class="special-card-context" id="leaderboardContext"></span></div>
                <div id="leaderboardContent"></div>
            </div>
        </div>
        <div id="filtersSection" class="filters-section hidden">
            <h2 style="margin-bottom: 20px; color: #333;">üîç Additional Filters</h2>
            <div class="filter-grid" id="filterGrid"></div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                <button class="btn btn-secondary" onclick="resetFilters()">Reset All</button>
                <button class="btn btn-secondary" onclick="exportFilteredData()">üì• Export to Excel</button>
            </div>
        </div>
        <div id="chartsContainer" class="hidden">
            <div class="section-title"><h2>Monthly Trends</h2></div>
            <div class="charts-section" id="trendChartsSection"></div>
            <div class="section-title"><h2>Risk & Credit Analysis</h2></div>
            <div class="charts-section" id="riskChartsSection"></div>
            <div class="section-title"><h2>Distribution Analysis</h2></div>
            <div class="charts-section" id="distributionChartsSection"></div>
            <div class="section-title"><h2>Geographic & Rate Analysis</h2></div>
            <div class="charts-section" id="geoChartsSection"></div>
        </div>
        <div id="tableSection" class="data-table-section hidden">
            <div class="summary-info"><h3>üìä Filtered Results Summary</h3><div class="summary-stats" id="summaryStats"></div></div>
            <div id="tableContainer"></div>
        </div>
    </div>
    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Processing files...</div>
    </div>
    <script>
        let rawData = [], filteredData = [], charts = {}, uploadedFiles = [];
        let selectedBuyer = '', selectedSeller = '', allSellersForDropdown = [];
        const COLUMNS = { buyer: 'Investor / Lender DBA Name', seller: 'Originator Dba Name', lockDate: 'Lock Approved Date', purpose: 'Purpose', program: 'Program', loanType: 'Loan Type', state: 'State', rate: 'Final Rate', loanAmount: 'LoanAmount', ltv: 'LTV', lockId: 'NexId', mortgageProduct: 'MortgageProduct', status: 'Status', creditScore: 'CreditScore', dscr: 'Override DSCR', incomeDoc: 'IncomeDocumentation', occupancy: 'Occupancy', prepayMonths: 'PrepayMonths' };

        function showLoading(t) { document.getElementById('loadingText').textContent = t; document.getElementById('loadingOverlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }
        function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('dragover'); }
        function handleDragLeave(e) { e.currentTarget.classList.remove('dragover'); }
        function handleDrop(e) { e.preventDefault(); e.currentTarget.classList.remove('dragover'); addFiles(Array.from(e.dataTransfer.files)); }
        function handleFileSelect(e) { addFiles(Array.from(e.target.files)); }
        function addFiles(files) { files.filter(f => f.name.endsWith('.xlsx') || f.name.endsWith('.xls')).forEach(f => { if (!uploadedFiles.find(x => x.name === f.name) && uploadedFiles.length < 10) uploadedFiles.push(f); }); updateFileList(); }
        function updateFileList() { const fl = document.getElementById('fileList'), pb = document.getElementById('processButtons'); if (!uploadedFiles.length) { fl.innerHTML = ''; pb.style.display = 'none'; return; } pb.style.display = 'flex'; fl.innerHTML = uploadedFiles.map((f, i) => `<div class="file-item"><div><div class="file-name">${f.name}</div></div><span class="file-remove" onclick="removeFile(${i})">√ó</span></div>`).join(''); }
        function removeFile(i) { uploadedFiles.splice(i, 1); updateFileList(); }
        function clearFiles() { uploadedFiles = []; updateFileList(); }
        function processAllFiles() { if (!uploadedFiles.length) { alert('Please upload at least one file'); return; } showLoading('Processing files...'); rawData = []; let cnt = 0; uploadedFiles.forEach(file => { const reader = new FileReader(); reader.onload = function(e) { try { const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true }); const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { raw: false, dateNF: 'yyyy-mm-dd' }); if (data.length) rawData = rawData.concat(data); } catch(err) { console.error(err); } if (++cnt === uploadedFiles.length) onAllFilesProcessed(); }; reader.readAsArrayBuffer(file); }); }
        function onAllFilesProcessed() { if (!rawData.length) { hideLoading(); alert('No data found'); return; } processData(); document.getElementById('uploadSection').style.display = 'none'; document.getElementById('headerActions').classList.remove('hidden'); hideLoading(); }
        function processData() { filteredData = [...rawData]; setupPrimaryFilters(); displayOverviewSection(); displayDateRange(); displayInitialStats(); displayStatusCard(); displayLeaderboardCard(); setupFilters(); displayAllCharts(); displayTable(); ['primaryFilters', 'statsSection', 'specialCardsSection', 'filtersSection', 'chartsContainer', 'tableSection'].forEach(id => document.getElementById(id).classList.remove('hidden')); }
        function escapeHtml(t) { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
        function setupPrimaryFilters() { const buyers = [...new Set(rawData.map(r => r[COLUMNS.buyer]).filter(Boolean))].sort(); document.getElementById('buyerFilter').innerHTML = `<option value="">All Buyers (${buyers.length})</option>` + buyers.map(b => `<option value="${escapeHtml(b)}">${escapeHtml(b)} (${rawData.filter(r => r[COLUMNS.buyer] === b).length.toLocaleString()})</option>`).join(''); updateSellerDropdown(); }
        function updateSellerDropdown() { const data = selectedBuyer ? rawData.filter(r => r[COLUMNS.buyer] === selectedBuyer) : rawData; const sc = {}; data.forEach(r => { const s = r[COLUMNS.seller]; if (s) sc[s] = (sc[s] || 0) + 1; }); allSellersForDropdown = Object.entries(sc).sort((a, b) => b[1] - a[1]).map(([name, count]) => ({ name, count })); renderSellerDropdownList(allSellersForDropdown); document.getElementById('sellerSearchInput').placeholder = `Search ${allSellersForDropdown.length} sellers...`; }
        function renderSellerDropdownList(sellers) { const list = document.getElementById('sellerDropdownList'); if (!sellers.length) { list.innerHTML = '<div style="padding:15px;color:#888;text-align:center;">No sellers found</div>'; return; } list.innerHTML = `<div class="searchable-dropdown-item ${!selectedSeller ? 'selected' : ''}" onclick="selectSeller('')"><span>All Sellers</span><span class="searchable-dropdown-item-count">${allSellersForDropdown.length}</span></div>` + sellers.map(({ name, count }) => `<div class="searchable-dropdown-item ${selectedSeller === name ? 'selected' : ''}" onclick="selectSeller('${escapeHtml(name).replace(/'/g, "\\'")}')" title="${escapeHtml(name)}"><span>${escapeHtml(name.length > 45 ? name.substring(0, 43) + '...' : name)}</span><span class="searchable-dropdown-item-count">${count.toLocaleString()}</span></div>`).join(''); }
        function toggleSellerDropdown(show) { document.getElementById('sellerDropdownList').classList.toggle('show', show); }
        function filterSellerList() { const term = document.getElementById('sellerSearchInput').value.toLowerCase().trim(); renderSellerDropdownList(term ? allSellersForDropdown.filter(({ name }) => name.toLowerCase().includes(term)) : allSellersForDropdown); toggleSellerDropdown(true); }
        function selectSeller(seller) { selectedSeller = seller; document.getElementById('sellerSearchInput').value = seller || ''; document.getElementById('sellerClearBtn').style.display = seller ? 'block' : 'none'; toggleSellerDropdown(false); }
        function clearSellerSelection(e) { if (e) e.stopPropagation(); selectedSeller = ''; document.getElementById('sellerSearchInput').value = ''; document.getElementById('sellerClearBtn').style.display = 'none'; renderSellerDropdownList(allSellersForDropdown); }
        document.addEventListener('click', function(e) { const dd = document.getElementById('sellerDropdown'); if (dd && !dd.contains(e.target)) toggleSellerDropdown(false); });
        function onBuyerChange() { selectedBuyer = document.getElementById('buyerFilter').value; if (selectedSeller && selectedBuyer && !rawData.some(r => r[COLUMNS.buyer] === selectedBuyer && r[COLUMNS.seller] === selectedSeller)) clearSellerSelection(); updateSellerDropdown(); }
        function applyPrimaryFilters() { showLoading('Applying filters...'); setTimeout(() => { filteredData = rawData.filter(row => (!selectedBuyer || row[COLUMNS.buyer] === selectedBuyer) && (!selectedSeller || row[COLUMNS.seller] === selectedSeller)); updateContextBanner(); refreshAllDisplays(); hideLoading(); }, 50); }
        function clearPrimaryFilters() { selectedBuyer = ''; selectedSeller = ''; document.getElementById('buyerFilter').value = ''; clearSellerSelection(); updateSellerDropdown(); filteredData = [...rawData]; updateContextBanner(); refreshAllDisplays(); }
        function selectFromOverviewCard(type, value) { if (type === 'buyer') { selectedBuyer = value; document.getElementById('buyerFilter').value = value; updateSellerDropdown(); } else if (type === 'seller') { selectedSeller = value; document.getElementById('sellerSearchInput').value = value; document.getElementById('sellerClearBtn').style.display = 'block'; } applyPrimaryFilters(); }
        function updateContextBanner() { const banner = document.getElementById('contextBanner'), text = document.getElementById('contextBannerText'); if (selectedBuyer || selectedSeller) { let msg = 'üìå Viewing: '; if (selectedSeller && !selectedBuyer) msg += `Seller: ${selectedSeller}`; else if (selectedBuyer && !selectedSeller) msg += `Buyer: ${selectedBuyer}`; else msg += `${selectedBuyer} ‚Üí ${selectedSeller}`; text.textContent = msg + ` (${filteredData.length.toLocaleString()} locks)`; banner.classList.remove('hidden'); } else banner.classList.add('hidden'); }
        function displayOverviewSection() { const section = document.getElementById('overviewSection'), title = document.getElementById('overviewTitle'), subtitle = document.getElementById('overviewSubtitle'), grid = document.getElementById('overviewCardsGrid'); if (selectedSeller && !selectedBuyer) { const buyerStats = {}; filteredData.forEach(row => { const b = row[COLUMNS.buyer] || 'Unknown'; if (!buyerStats[b]) buyerStats[b] = { count: 0, states: new Set() }; buyerStats[b].count++; if (row[COLUMNS.state]) buyerStats[b].states.add(row[COLUMNS.state]); }); const sorted = Object.entries(buyerStats).sort((a, b) => b[1].count - a[1].count); if (sorted.length <= 1) { section.classList.add('hidden'); return; } title.textContent = `üè¢ Buyers for "${selectedSeller.length > 30 ? selectedSeller.substring(0, 28) + '...' : selectedSeller}"`; subtitle.textContent = `This seller has locked with ${sorted.length} buyer(s). Click a card to drill down.`; grid.innerHTML = sorted.slice(0, 12).map(([buyer, stats]) => `<div class="overview-card" onclick="selectFromOverviewCard('buyer', '${escapeHtml(buyer).replace(/'/g, "\\'")}')" title="${escapeHtml(buyer)}"><div class="overview-card-name">${escapeHtml(buyer)}</div><div class="overview-card-stats"><span class="overview-card-locks">${stats.count.toLocaleString()} locks</span><span class="overview-card-secondary">${stats.states.size} states</span></div></div>`).join(''); section.classList.remove('hidden'); } else { const buyerStats = {}; rawData.forEach(row => { const b = row[COLUMNS.buyer] || 'Unknown'; if (!buyerStats[b]) buyerStats[b] = { count: 0, sellers: new Set() }; buyerStats[b].count++; if (row[COLUMNS.seller]) buyerStats[b].sellers.add(row[COLUMNS.seller]); }); const sorted = Object.entries(buyerStats).sort((a, b) => b[1].count - a[1].count); if (sorted.length <= 1) { section.classList.add('hidden'); return; } title.textContent = 'üìä Buyer Overview'; subtitle.textContent = 'Click a buyer card to filter, or use the dropdown above'; grid.innerHTML = sorted.slice(0, 12).map(([buyer, stats]) => `<div class="overview-card ${selectedBuyer === buyer ? 'selected' : ''}" onclick="selectFromOverviewCard('buyer', '${escapeHtml(buyer).replace(/'/g, "\\'")}')" title="${escapeHtml(buyer)}"><div class="overview-card-name">${escapeHtml(buyer)}</div><div class="overview-card-stats"><span class="overview-card-locks">${stats.count.toLocaleString()} locks</span><span class="overview-card-secondary">${stats.sellers.size} sellers</span></div></div>`).join(''); section.classList.remove('hidden'); } }
        function refreshAllDisplays() { displayOverviewSection(); displayDateRange(); displayInitialStats(); displayStatusCard(); displayLeaderboardCard(); setupFilters(); displayAllCharts(); displayTable(); }
        function parseDate(v) { if (!v) return null; if (v instanceof Date) return v; if (typeof v === 'number' && v > 25000 && v < 50000) return new Date((v - 25569) * 86400 * 1000); const p = new Date(v); return isNaN(p.getTime()) ? null : p; }
        function formatDate(d) { return d ? d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : '-'; }
        function formatMonthYear(d) { if (!d) return '-'; const m = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']; return m[d.getMonth()] + ' ' + d.getFullYear(); }
        function parseMonthYear(s) { const m = { Jan: 0, Feb: 1, Mar: 2, Apr: 3, May: 4, Jun: 5, Jul: 6, Aug: 7, Sep: 8, Oct: 9, Nov: 10, Dec: 11 }; const p = s.split(' '); return new Date(parseInt(p[1]), m[p[0]], 1); }
        function getValueCounts(data, col) { const c = {}; data.forEach(r => { const v = r[col] || 'Unknown'; c[v] = (c[v] || 0) + 1; }); return c; }
        function displayDateRange() { const dates = filteredData.map(r => parseDate(r[COLUMNS.lockDate])).filter(d => d).sort((a, b) => a - b); if (dates.length) { document.getElementById('dateInfo').innerHTML = `üìÖ Data Range: <span>${formatDate(dates[0])}</span> to <span>${formatDate(dates[dates.length - 1])}</span> | <span>${filteredData.length.toLocaleString()}</span> total locks`; document.getElementById('dateInfo').classList.remove('hidden'); } }
        function calculateStats(data) { const s = { totalLocks: data.length, uniqueSellers: new Set(data.map(r => r[COLUMNS.seller]).filter(Boolean)).size, purchaseCount: 0, ltvs: [], ficos: [] }; data.forEach(r => { if (r[COLUMNS.purpose] === 'Purchase') s.purchaseCount++; const ltv = parseFloat(r[COLUMNS.ltv]), fico = parseFloat(r[COLUMNS.creditScore]); if (!isNaN(ltv)) s.ltvs.push(ltv); if (!isNaN(fico) && fico > 0) s.ficos.push(fico); }); s.purchasePercent = s.totalLocks > 0 ? ((s.purchaseCount / s.totalLocks) * 100).toFixed(1) : 0; s.avgLTV = s.ltvs.length > 0 ? ((s.ltvs.reduce((a, b) => a + b, 0) / s.ltvs.length) * 100).toFixed(1) : 0; s.avgFico = s.ficos.length > 0 ? Math.round(s.ficos.reduce((a, b) => a + b, 0) / s.ficos.length) : 'N/A'; return s; }
        function displayInitialStats() { const s = calculateStats(filteredData); const ub = new Set(filteredData.map(r => r[COLUMNS.buyer]).filter(Boolean)).size; document.getElementById('statsGrid').innerHTML = [{ label: 'Total Locks', value: s.totalLocks.toLocaleString(), detail: 'Total records' }, { label: 'Buyers', value: ub.toLocaleString(), detail: 'Unique investors' }, { label: 'Sellers', value: s.uniqueSellers.toLocaleString(), detail: 'Unique originators' }, { label: 'Purchase', value: s.purchasePercent + '%', detail: s.purchaseCount.toLocaleString() + ' locks' }, { label: 'Avg FICO', value: s.avgFico, detail: 'Credit score' }, { label: 'Avg LTV', value: s.avgLTV + '%', detail: 'Loan to value' }].map(st => `<div class="stat-card"><div class="stat-label">${st.label}</div><div class="stat-value">${st.value}</div><div class="stat-detail">${st.detail}</div></div>`).join(''); }
        function displayStatusCard() { const sc = getValueCounts(filteredData, COLUMNS.status); const sorted = Object.entries(sc).sort((a, b) => b[1] - a[1]); const total = sorted.reduce((s, [_, c]) => s + c, 0); const la = sorted.find(([s]) => s === 'Lock Approved'); const laCount = la ? la[1] : 0, laPct = total > 0 ? ((laCount / total) * 100).toFixed(1) : 0; const others = sorted.filter(([s]) => s !== 'Lock Approved'); let ctx = ''; if (selectedSeller && selectedBuyer) ctx = `${selectedBuyer.substring(0, 15)}... + ${selectedSeller.substring(0, 15)}...`; else if (selectedSeller) ctx = `for ${selectedSeller.length > 25 ? selectedSeller.substring(0, 23) + '...' : selectedSeller}`; else if (selectedBuyer) ctx = `for ${selectedBuyer.length > 25 ? selectedBuyer.substring(0, 23) + '...' : selectedBuyer}`; document.getElementById('statusContext').textContent = ctx; document.getElementById('statusContext').style.display = ctx ? 'inline-block' : 'none'; let html = `<div class="status-main"><div><div class="status-main-label">‚úÖ Lock Approved</div><div class="status-main-percent">${laPct}% of total</div></div><div class="status-main-value">${laCount.toLocaleString()}</div></div>`; if (others.length) { html += `<div class="status-others-title">Other Statuses</div><div class="status-others-grid">`; others.forEach(([status, count]) => { let cls = 'status-other-item'; if (status.toLowerCase().includes('cancel')) cls += ' cancelled'; else cls += ' pending'; html += `<div class="${cls}" title="${status}"><span class="status-other-label">${status.length > 18 ? status.substring(0, 16) + '...' : status}</span><span class="status-other-value">${count.toLocaleString()}</span></div>`; }); html += `</div>`; } document.getElementById('statusContent').innerHTML = html; }
        function displayLeaderboardCard() { const showBuyers = selectedSeller && !selectedBuyer; const counts = getValueCounts(filteredData, showBuyers ? COLUMNS.buyer : COLUMNS.seller); const title = showBuyers ? 'Top 10 Buyers by Lock Volume' : 'Top 10 Sellers by Lock Volume'; const ctx = showBuyers ? `for ${selectedSeller.length > 20 ? selectedSeller.substring(0, 18) + '...' : selectedSeller}` : (selectedBuyer ? `for ${selectedBuyer.length > 20 ? selectedBuyer.substring(0, 18) + '...' : selectedBuyer}` : ''); document.getElementById('leaderboardTitle').textContent = title; document.getElementById('leaderboardContext').textContent = ctx; document.getElementById('leaderboardContext').style.display = ctx ? 'inline-block' : 'none'; const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 10); const max = sorted.length > 0 ? sorted[0][1] : 1; document.getElementById('leaderboardContent').innerHTML = '<div class="leaderboard-list">' + sorted.map(([name, count], i) => { const rc = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : 'other'; return `<div class="leaderboard-item" title="${name}"><div class="leaderboard-rank ${rc}">${i + 1}</div><div class="leaderboard-info"><div class="leaderboard-name">${name.length > 35 ? name.substring(0, 33) + '...' : name}</div><div class="leaderboard-bar-container"><div class="leaderboard-bar" style="width: ${(count / max) * 100}%"></div></div></div><div class="leaderboard-count">${count.toLocaleString()}</div></div>`; }).join('') + '</div>'; }
        function setupFilters() { const purposes = [...new Set(filteredData.map(r => r[COLUMNS.purpose]).filter(Boolean))].sort(); const programs = [...new Set(filteredData.map(r => r[COLUMNS.program]).filter(Boolean))].sort(); const loanTypes = [...new Set(filteredData.map(r => r[COLUMNS.loanType]).filter(Boolean))].sort(); const states = [...new Set(filteredData.map(r => r[COLUMNS.state]).filter(Boolean))].sort(); const statuses = [...new Set(filteredData.map(r => r[COLUMNS.status]).filter(Boolean))].sort(); document.getElementById('filterGrid').innerHTML = `<div class="filter-group"><label class="filter-label">Purpose</label><select class="filter-select" id="filterPurpose"><option value="">All Purposes</option>${purposes.map(p => `<option value="${p}">${p}</option>`).join('')}</select></div><div class="filter-group"><label class="filter-label">Program</label><select class="filter-select" id="filterProgram"><option value="">All Programs</option>${programs.map(p => `<option value="${p}">${p}</option>`).join('')}</select></div><div class="filter-group"><label class="filter-label">Loan Type</label><select class="filter-select" id="filterLoanType"><option value="">All Loan Types</option>${loanTypes.map(t => `<option value="${t}">${t}</option>`).join('')}</select></div><div class="filter-group"><label class="filter-label">State</label><select class="filter-select" id="filterState"><option value="">All States</option>${states.map(s => `<option value="${s}">${s}</option>`).join('')}</select></div><div class="filter-group"><label class="filter-label">Status</label><select class="filter-select" id="filterStatus"><option value="">All Statuses</option>${statuses.map(s => `<option value="${s}">${s}</option>`).join('')}</select></div><div class="filter-group"><label class="filter-label">Date Range</label><div class="range-input-group"><input type="date" class="date-input" id="filterDateFrom"><span>to</span><input type="date" class="date-input" id="filterDateTo"></div></div>`; }
        function applyFilters() { showLoading('Applying filters...'); setTimeout(() => { const pf = document.getElementById('filterPurpose').value, pr = document.getElementById('filterProgram').value, lt = document.getElementById('filterLoanType').value, st = document.getElementById('filterState').value, ss = document.getElementById('filterStatus').value, df = document.getElementById('filterDateFrom').value, dt = document.getElementById('filterDateTo').value; let base = rawData; if (selectedBuyer) base = base.filter(r => r[COLUMNS.buyer] === selectedBuyer); if (selectedSeller) base = base.filter(r => r[COLUMNS.seller] === selectedSeller); filteredData = base.filter(row => { if (pf && row[COLUMNS.purpose] !== pf) return false; if (pr && row[COLUMNS.program] !== pr) return false; if (lt && row[COLUMNS.loanType] !== lt) return false; if (st && row[COLUMNS.state] !== st) return false; if (ss && row[COLUMNS.status] !== ss) return false; if (df || dt) { const ld = parseDate(row[COLUMNS.lockDate]); if (!ld) return false; if (df && ld < new Date(df)) return false; if (dt && ld > new Date(dt + 'T23:59:59')) return false; } return true; }); displayDateRange(); displayInitialStats(); displayStatusCard(); displayLeaderboardCard(); displayAllCharts(); displayTable(); hideLoading(); }, 100); }
        function resetFilters() { ['filterPurpose', 'filterProgram', 'filterLoanType', 'filterState', 'filterStatus', 'filterDateFrom', 'filterDateTo'].forEach(id => document.getElementById(id).value = ''); let base = rawData; if (selectedBuyer) base = base.filter(r => r[COLUMNS.buyer] === selectedBuyer); if (selectedSeller) base = base.filter(r => r[COLUMNS.seller] === selectedSeller); filteredData = base; displayDateRange(); displayInitialStats(); displayStatusCard(); displayLeaderboardCard(); displayAllCharts(); displayTable(); }
        function exportFilteredData() { if (!filteredData.length) { alert('No data to export'); return; } showLoading('Exporting...'); setTimeout(() => { const ws = XLSX.utils.json_to_sheet(filteredData); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Filtered Data'); XLSX.writeFile(wb, 'filtered_lock_data.xlsx'); hideLoading(); }, 100); }
        function displayAllCharts() { Object.values(charts).forEach(c => { if (c && typeof c.destroy === 'function') c.destroy(); }); charts = {}; const trend = document.getElementById('trendChartsSection'), risk = document.getElementById('riskChartsSection'), dist = document.getElementById('distributionChartsSection'), geo = document.getElementById('geoChartsSection'); trend.innerHTML = ''; risk.innerHTML = ''; dist.innerHTML = ''; geo.innerHTML = ''; trend.appendChild(createChartContainer('Unique Sellers Per Month', 'sellersChart')); createSellersChart(); trend.appendChild(createChartContainer('Total Locks Per Month', 'locksChart')); createLocksChart(); trend.appendChild(createChartContainer('Fixed vs ARM Locks', 'fixedArmChart')); createFixedArmChart(); risk.appendChild(createChartContainer('FICO Score Distribution', 'ficoChart')); createFicoChart(); risk.appendChild(createChartContainer('LTV Distribution', 'ltvChart')); createLtvChart(); risk.appendChild(createChartContainer('DSCR Distribution', 'dscrChart', 'DSCR / No Ratio DSCR loans only')); createDscrChart(); risk.appendChild(createChartContainer('Prepayment Term Distribution', 'prepayChart', 'Investment property loans only')); createPrepayChart(); dist.appendChild(createChartContainer('Loan Purpose Breakdown', 'purposeChart')); createPurposeChart(); dist.appendChild(createChartContainer('Program Breakdown', 'programChart')); createProgramChart(); dist.appendChild(createChartContainer('Loan Type Breakdown', 'loanTypeChart')); createLoanTypeChart(); geo.appendChild(createChartContainer('Top 10 States', 'stateChart')); createStateChart(); geo.appendChild(createChartContainer('Interest Rate Distribution', 'rateChart')); createRateChart(); }
        function createChartContainer(title, id, sub = null) { const c = document.createElement('div'); c.className = 'chart-container'; c.id = id + 'Container'; c.innerHTML = `<h3 class="chart-title">${title}</h3>${sub ? `<p class="chart-subtitle">${sub}</p>` : ''}<div class="chart-wrapper"><canvas id="${id}"></canvas></div>`; return c; }
        function createSellersChart() { const md = {}; filteredData.forEach(r => { const d = parseDate(r[COLUMNS.lockDate]); if (!d) return; const m = formatMonthYear(d), s = r[COLUMNS.seller]; if (!s) return; if (!md[m]) md[m] = new Set(); md[m].add(s); }); const months = Object.keys(md).sort((a, b) => parseMonthYear(a) - parseMonthYear(b)); charts.sellers = new Chart(document.getElementById('sellersChart').getContext('2d'), { type: 'bar', data: { labels: months, datasets: [{ label: 'Unique Sellers', data: months.map(m => md[m].size), backgroundColor: 'rgba(78, 205, 196, 0.7)', borderColor: '#4ECDC4', borderWidth: 2, borderRadius: 8 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Unique Sellers' } }, x: { title: { display: true, text: 'Month' } } } } }); }
        function createLocksChart() { const md = {}; filteredData.forEach(r => { const d = parseDate(r[COLUMNS.lockDate]); if (!d) return; const m = formatMonthYear(d); md[m] = (md[m] || 0) + 1; }); const months = Object.keys(md).sort((a, b) => parseMonthYear(a) - parseMonthYear(b)); charts.locks = new Chart(document.getElementById('locksChart').getContext('2d'), { type: 'line', data: { labels: months, datasets: [{ label: 'Total Locks', data: months.map(m => md[m]), backgroundColor: 'rgba(68, 160, 141, 0.2)', borderColor: '#44A08D', borderWidth: 3, fill: true, tension: 0.4, pointRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Number of Locks' } } } } }); }
        function createFixedArmChart() { const md = {}; filteredData.forEach(r => { const d = parseDate(r[COLUMNS.lockDate]); if (!d) return; const m = formatMonthYear(d); if (!md[m]) md[m] = { fixed: 0, arm: 0 }; const p = (r[COLUMNS.mortgageProduct] || '').toString().toUpperCase(); if (p.includes('ARM') || p.includes('/') || p.includes('ADJUSTABLE')) md[m].arm++; else md[m].fixed++; }); const months = Object.keys(md).sort((a, b) => parseMonthYear(a) - parseMonthYear(b)); charts.fixedArm = new Chart(document.getElementById('fixedArmChart').getContext('2d'), { type: 'bar', data: { labels: months, datasets: [{ label: 'Fixed Rate', data: months.map(m => md[m].fixed), backgroundColor: 'rgba(78, 205, 196, 0.8)', borderColor: '#4ECDC4', borderWidth: 1, borderRadius: 4 }, { label: 'ARM', data: months.map(m => md[m].arm), backgroundColor: 'rgba(68, 160, 141, 0.8)', borderColor: '#44A08D', borderWidth: 1, borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Number of Locks' } } } } }); }
        function createFicoChart() { const ficos = filteredData.map(r => parseFloat(r[COLUMNS.creditScore])).filter(f => !isNaN(f) && f > 0); const bins = { '< 620': 0, '620-659': 0, '660-699': 0, '700-739': 0, '740-779': 0, '780+': 0 }; ficos.forEach(s => { if (s < 620) bins['< 620']++; else if (s < 660) bins['620-659']++; else if (s < 700) bins['660-699']++; else if (s < 740) bins['700-739']++; else if (s < 780) bins['740-779']++; else bins['780+']++; }); charts.fico = new Chart(document.getElementById('ficoChart').getContext('2d'), { type: 'bar', data: { labels: Object.keys(bins), datasets: [{ label: 'Loans', data: Object.values(bins), backgroundColor: ['rgba(255, 99, 132, 0.7)', 'rgba(255, 159, 64, 0.7)', 'rgba(255, 205, 86, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(78, 205, 196, 0.7)'], borderWidth: 2, borderRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Number of Loans' } }, x: { title: { display: true, text: 'FICO Score Range' } } } } }); }
        function createLtvChart() { const ltvs = filteredData.map(r => parseFloat(r[COLUMNS.ltv])).filter(l => !isNaN(l)); const bins = { '‚â§ 50%': 0, '50-60%': 0, '60-70%': 0, '70-75%': 0, '75-80%': 0, '> 80%': 0 }; ltvs.forEach(l => { const p = l * 100; if (p <= 50) bins['‚â§ 50%']++; else if (p <= 60) bins['50-60%']++; else if (p <= 70) bins['60-70%']++; else if (p <= 75) bins['70-75%']++; else if (p <= 80) bins['75-80%']++; else bins['> 80%']++; }); charts.ltv = new Chart(document.getElementById('ltvChart').getContext('2d'), { type: 'bar', data: { labels: Object.keys(bins), datasets: [{ label: 'Loans', data: Object.values(bins), backgroundColor: 'rgba(68, 160, 141, 0.7)', borderColor: '#44A08D', borderWidth: 2, borderRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Number of Loans' } }, x: { title: { display: true, text: 'LTV Range' } } } } }); }
        function createDscrChart() { const dscrLoans = filteredData.filter(r => r[COLUMNS.incomeDoc] === 'DSCR  / No Ratio DSCR'); const approved = dscrLoans.filter(r => r[COLUMNS.status] === 'Lock Approved').map(r => parseFloat(r[COLUMNS.dscr])).filter(d => !isNaN(d) && d > 0); const cancelled = dscrLoans.filter(r => r[COLUMNS.status] === 'Cancelled').map(r => parseFloat(r[COLUMNS.dscr])).filter(d => !isNaN(d) && d > 0); const labels = ['< 1.0', '1.0-1.1', '1.1-1.2', '1.2-1.3', '1.3-1.4', '1.4+']; function bin(dscrs) { const b = [0, 0, 0, 0, 0, 0]; dscrs.forEach(d => { if (d < 1.0) b[0]++; else if (d < 1.1) b[1]++; else if (d < 1.2) b[2]++; else if (d < 1.3) b[3]++; else if (d < 1.4) b[4]++; else b[5]++; }); return b; } charts.dscr = new Chart(document.getElementById('dscrChart').getContext('2d'), { type: 'bar', data: { labels, datasets: [{ label: 'Lock Approved', data: bin(approved), backgroundColor: 'rgba(78, 205, 196, 0.7)', borderColor: '#4ECDC4', borderWidth: 2, borderRadius: 4 }, { label: 'Cancelled', data: bin(cancelled), backgroundColor: 'rgba(255, 107, 107, 0.7)', borderColor: '#FF6B6B', borderWidth: 2, borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Number of Loans' } }, x: { title: { display: true, text: 'DSCR Range' } } } } }); }
        function createPrepayChart() { const inv = filteredData.filter(r => r[COLUMNS.occupancy] === 'Investment'); const terms = inv.map(r => parseFloat(r[COLUMNS.prepayMonths])).filter(p => !isNaN(p)); const groups = {}; terms.forEach(t => { const l = t === 0 ? 'No Prepay' : `${t} months`; groups[l] = (groups[l] || 0) + 1; }); const sorted = Object.entries(groups).sort((a, b) => { if (a[0] === 'No Prepay') return -1; if (b[0] === 'No Prepay') return 1; return parseInt(a[0]) - parseInt(b[0]); }); charts.prepay = new Chart(document.getElementById('prepayChart').getContext('2d'), { type: 'bar', data: { labels: sorted.map(g => g[0]), datasets: [{ label: 'Loans', data: sorted.map(g => g[1]), backgroundColor: 'rgba(153, 102, 255, 0.7)', borderColor: 'rgb(153, 102, 255)', borderWidth: 2, borderRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Number of Loans' } }, x: { title: { display: true, text: 'Prepayment Term' } } } } }); }
        function createPurposeChart() { const counts = getValueCounts(filteredData, COLUMNS.purpose); charts.purpose = new Chart(document.getElementById('purposeChart').getContext('2d'), { type: 'doughnut', data: { labels: Object.keys(counts), datasets: [{ data: Object.values(counts), backgroundColor: ['#4ECDC4', '#44A08D', '#43e97b', '#38f9d7', '#4facfe'], borderWidth: 2, borderColor: '#fff' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } }); }
        function createProgramChart() { const counts = getValueCounts(filteredData, COLUMNS.program); const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]); const colors = sorted.map((_, i) => `rgba(${78 + (68 - 78) * i / sorted.length}, ${205 + (160 - 205) * i / sorted.length}, ${196 + (141 - 196) * i / sorted.length}, 0.8)`); charts.program = new Chart(document.getElementById('programChart').getContext('2d'), { type: 'bar', data: { labels: sorted.map(s => s[0].length > 25 ? s[0].substring(0, 23) + '...' : s[0]), datasets: [{ label: 'Locks', data: sorted.map(s => s[1]), backgroundColor: colors, borderColor: '#44A08D', borderWidth: 1, borderRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, title: { display: true, text: 'Number of Locks' } } } } }); }
        function createLoanTypeChart() { const counts = getValueCounts(filteredData, COLUMNS.loanType); charts.loanType = new Chart(document.getElementById('loanTypeChart').getContext('2d'), { type: 'pie', data: { labels: Object.keys(counts), datasets: [{ data: Object.values(counts), backgroundColor: ['#4ECDC4', '#FF6B6B', '#43e97b', '#4facfe', '#f093fb'], borderWidth: 3, borderColor: '#fff' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } }); }
        function createStateChart() { const counts = getValueCounts(filteredData, COLUMNS.state); const top = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 10); charts.state = new Chart(document.getElementById('stateChart').getContext('2d'), { type: 'bar', data: { labels: top.map(s => s[0]), datasets: [{ label: 'Locks', data: top.map(s => s[1]), backgroundColor: 'rgba(68, 160, 141, 0.7)', borderColor: '#44A08D', borderWidth: 2, borderRadius: 8 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Number of Locks' } } } } }); }
        function createRateChart() { const rates = filteredData.map(r => parseFloat(r[COLUMNS.rate])).filter(r => !isNaN(r)); if (!rates.length) return; const min = Math.min(...rates), max = Math.max(...rates), binSize = (max - min) / 12; const bins = Array(12).fill(0), labels = []; for (let i = 0; i < 12; i++) { const bMin = min + i * binSize, bMax = min + (i + 1) * binSize; labels.push(bMin.toFixed(2) + '-' + bMax.toFixed(2)); rates.forEach(v => { if (v >= bMin && (v < bMax || (i === 11 && v === max))) bins[i]++; }); } charts.rate = new Chart(document.getElementById('rateChart').getContext('2d'), { type: 'bar', data: { labels, datasets: [{ label: 'Locks', data: bins, backgroundColor: 'rgba(78, 205, 196, 0.7)', borderColor: '#4ECDC4', borderWidth: 1, borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Number of Locks' } }, x: { title: { display: true, text: 'Interest Rate (%)' } } } } }); }
        function displayTable() { const display = filteredData.slice(0, 100); let html = `<p style="margin-bottom: 15px; color: #666;">Showing ${display.length} of ${filteredData.length.toLocaleString()} records</p><table><thead><tr><th>Lock ID</th><th>Buyer</th><th>Seller</th><th>Lock Date</th><th>Status</th><th>State</th><th>FICO</th><th>LTV</th><th>Rate</th><th>Loan Amount</th></tr></thead><tbody>`; display.forEach(r => { const d = parseDate(r[COLUMNS.lockDate]); const ltv = parseFloat(r[COLUMNS.ltv]); html += `<tr><td>${r[COLUMNS.lockId] || '-'}</td><td title="${r[COLUMNS.buyer] || ''}">${(r[COLUMNS.buyer] || '-').substring(0, 20)}</td><td title="${r[COLUMNS.seller] || ''}">${(r[COLUMNS.seller] || '-').substring(0, 25)}</td><td>${d ? formatDate(d) : '-'}</td><td>${r[COLUMNS.status] || '-'}</td><td>${r[COLUMNS.state] || '-'}</td><td>${r[COLUMNS.creditScore] || '-'}</td><td>${!isNaN(ltv) ? (ltv * 100).toFixed(1) + '%' : '-'}</td><td>${r[COLUMNS.rate] || '-'}</td><td>${r[COLUMNS.loanAmount] ? '$' + parseFloat(r[COLUMNS.loanAmount]).toLocaleString() : '-'}</td></tr>`; }); html += '</tbody></table>'; document.getElementById('tableContainer').innerHTML = html; const s = calculateStats(filteredData); const ub = new Set(filteredData.map(r => r[COLUMNS.buyer]).filter(Boolean)).size; document.getElementById('summaryStats').innerHTML = `<div class="summary-stat"><span class="summary-stat-label">Total Records:</span><span class="summary-stat-value">${s.totalLocks.toLocaleString()}</span></div><div class="summary-stat"><span class="summary-stat-label">Buyers:</span><span class="summary-stat-value">${ub}</span></div><div class="summary-stat"><span class="summary-stat-label">Sellers:</span><span class="summary-stat-value">${s.uniqueSellers}</span></div><div class="summary-stat"><span class="summary-stat-label">Avg FICO:</span><span class="summary-stat-value">${s.avgFico}</span></div><div class="summary-stat"><span class="summary-stat-label">Avg LTV:</span><span class="summary-stat-value">${s.avgLTV}%</span></div>`; }
        async function exportToPDF() { showLoading('Generating PDF...'); try { const { jsPDF } = window.jspdf; const pdf = new jsPDF('landscape', 'mm', 'a4'); const pw = pdf.internal.pageSize.getWidth(), ph = pdf.internal.pageSize.getHeight(), m = 15; pdf.setFillColor(78, 205, 196); pdf.rect(0, 0, pw, 50, 'F'); pdf.setTextColor(255, 255, 255); pdf.setFontSize(32); pdf.setFont('helvetica', 'bold'); pdf.text('Lock Data Analytics Report', pw / 2, 30, { align: 'center' }); pdf.setFontSize(12); pdf.setFont('helvetica', 'normal'); pdf.text('Generated: ' + new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }), pw / 2, 42, { align: 'center' }); let y = 60; if (selectedBuyer || selectedSeller) { pdf.setTextColor(68, 160, 141); pdf.setFontSize(14); let ft = 'Filtered: '; if (selectedSeller && !selectedBuyer) ft += 'Seller: ' + selectedSeller; else if (selectedBuyer && !selectedSeller) ft += 'Buyer: ' + selectedBuyer; else ft += selectedBuyer + ' ‚Üí ' + selectedSeller; pdf.text(ft, pw / 2, y, { align: 'center' }); y += 10; } pdf.setTextColor(51, 51, 51); pdf.setFontSize(11); pdf.text('Total Locks: ' + filteredData.length.toLocaleString(), m, y + 15); pdf.text('Unique Buyers: ' + new Set(filteredData.map(r => r[COLUMNS.buyer]).filter(Boolean)).size, m + 80, y + 15); pdf.text('Unique Sellers: ' + calculateStats(filteredData).uniqueSellers, m + 160, y + 15); const chartIds = ['sellersChartContainer', 'locksChartContainer', 'fixedArmChartContainer', 'ficoChartContainer', 'ltvChartContainer', 'dscrChartContainer', 'prepayChartContainer', 'purposeChartContainer', 'programChartContainer', 'loanTypeChartContainer', 'stateChartContainer', 'rateChartContainer']; for (const id of chartIds) { const el = document.getElementById(id); if (el) { pdf.addPage(); const canvas = await html2canvas(el, { scale: 1.2, backgroundColor: '#ffffff', logging: false }); const imgData = canvas.toDataURL('image/jpeg', 0.7); const imgW = pw - m * 2, imgH = (canvas.height * imgW) / canvas.width; const finalH = Math.min(imgH, ph - 40); const finalW = (finalH === ph - 40) ? (canvas.width * finalH) / canvas.height : imgW; pdf.addImage(imgData, 'JPEG', (pw - finalW) / 2, 25, finalW, finalH, undefined, 'FAST'); } } pdf.save('lock_analytics_report.pdf'); hideLoading(); } catch (err) { console.error(err); hideLoading(); alert('Error generating PDF'); } }
        function resetDashboard() { if (confirm('Start a new analysis?')) location.reload(); }
        console.log('Lock Data Analytics Dashboard v5.0 with Bidirectional Filtering loaded!');
    </script>
</body>
</html>
