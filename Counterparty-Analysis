<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buyer-Seller Counterparty Analysis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        h2 {
            color: #555;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background: #f8f9ff;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            background: #e8ebff;
            border-color: #764ba2;
        }
        
        .upload-area.dragover {
            background: #e8ebff;
            border-color: #764ba2;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .mode-selector {
            display: flex;
            gap: 20px;
            margin: 30px 0;
            justify-content: center;
        }
        
        .mode-card {
            flex: 1;
            padding: 30px;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        .mode-card:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }
        
        .mode-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #f0f4ff 0%, #e8ebff 100%);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        
        .mode-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        
        .mode-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .mode-description {
            color: #666;
            font-size: 0.95em;
        }
        
        .entity-selection {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .entity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: white;
        }
        
        .entity-item {
            padding: 10px;
            background: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .entity-item:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .entity-item.selected {
            border-color: #667eea;
            background: #e8ebff;
        }
        
        .entity-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .entity-item label {
            cursor: pointer;
            flex: 1;
            font-size: 0.95em;
        }
        
        .search-box {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .selection-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .selection-controls button {
            padding: 8px 15px;
            font-size: 0.9em;
            background: #6c757d;
        }
        
        .selection-controls button.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .selected-count {
            padding: 10px;
            background: #e8ebff;
            border-radius: 6px;
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
            color: #667eea;
        }
        
        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            background: #f0f4f8;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }
        
        .status.processing {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        
        .status.success {
            background: #d4edda;
            border-left-color: #28a745;
        }
        
        .status.error {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 20px;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .report-preview {
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .report-section {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .report-section h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        
        .entity-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .entity-card {
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .entity-card.active {
            background: #e8fff0;
            border-color: #28a745;
        }
        
        .entity-card.inactive {
            background: #fff5f5;
            border-color: #dc3545;
        }
        
        .hidden {
            display: none !important;
        }
        
        #fileInput {
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Buyer-Seller Counterparty Analysis</h1>
        <div class="subtitle">Analyze counterparty relationships and pricing tier configurations between buyers and sellers</div>
        
        <!-- Step 1: Upload -->
        <div id="uploadSection">
            <div class="upload-area" onclick="document.getElementById('fileInput').click()" 
                 ondrop="handleDrop(event)" 
                 ondragover="handleDragOver(event)" 
                 ondragleave="handleDragLeave(event)">
                <div class="upload-icon">üìÅ</div>
                <h3>Click to select or drag & drop your CSV file</h3>
                <p style="color: #888;">AllUsers_20250807.csv or similar user export file</p>
            </div>
            <input type="file" id="fileInput" accept=".csv" onchange="handleFileSelect(event)">
        </div>

        <!-- Step 2: Choose Mode -->
        <div id="modeSection" class="hidden">
            <div id="loadingStatus" class="status">
                Processing CSV file...
            </div>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width: 0%"></div>
            </div>

            <div id="modeSelectionArea" class="hidden">
                <h2>Choose Analysis Mode</h2>
                <div class="mode-selector">
                    <div class="mode-card" onclick="selectMode('buyer')">
                        <div class="mode-icon">üè¢</div>
                        <div class="mode-title">Buyer Analysis</div>
                        <div class="mode-description">Select buyers to see their counterpartied sellers and active relationships</div>
                    </div>
                    <div class="mode-card" onclick="selectMode('seller')">
                        <div class="mode-icon">üè™</div>
                        <div class="mode-title">Seller Analysis</div>
                        <div class="mode-description">Select sellers to see their counterpartied buyers and active relationships</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Select Entities -->
        <div id="selectionSection" class="hidden">
            <div id="entitySelectionArea" class="entity-selection">
                <h2 id="selectionTitle">üìã Select Items to Analyze</h2>
                <div class="selected-count" id="selectedCount">0 items selected</div>
                
                <input type="text" class="search-box" id="searchBox" placeholder="üîç Search..." onkeyup="filterEntities()">
                
                <div class="selection-controls">
                    <button class="primary" onclick="selectAll()">Select All</button>
                    <button onclick="selectNone()">Clear All</button>
                    <button onclick="selectFiltered()">Select Visible</button>
                </div>
                
                <div class="entity-grid" id="entityGrid">
                    <!-- Entities will be populated here -->
                </div>
                
                <button id="analyzeBtn" onclick="analyzeSelected()" disabled>
                    üìä Generate Report
                </button>
                <button onclick="backToModeSelection()" style="background: #6c757d;">
                    ‚¨ÖÔ∏è Back to Mode Selection
                </button>
                <button onclick="resetTool()" style="background: #6c757d;">
                    üîÑ Start Over with New File
                </button>
            </div>
        </div>

        <!-- Step 4: Results -->
        <div id="resultsSection" class="hidden">
            <div id="resultStatus" class="status success">
                Analysis complete!
            </div>
            
            <div id="stats" class="stats">
                <div class="stat-card">
                    <div id="stat1Number" class="stat-number">0</div>
                    <div id="stat1Label" class="stat-label">Items Analyzed</div>
                </div>
                <div class="stat-card">
                    <div id="stat2Number" class="stat-number">0</div>
                    <div id="stat2Label" class="stat-label">Total Counterparties</div>
                </div>
                <div class="stat-card">
                    <div id="stat3Number" class="stat-number">0</div>
                    <div id="stat3Label" class="stat-label">Active Relationships</div>
                </div>
                <div class="stat-card">
                    <div id="stat4Number" class="stat-number">0%</div>
                    <div id="stat4Label" class="stat-label">Activity Rate</div>
                </div>
            </div>
            
            <div id="reportPreview" class="report-preview">
                <!-- Preview will be shown here -->
            </div>
            
            <button onclick="downloadExcel()">üíæ Download Excel Report</button>
            <button onclick="backToSelection()" style="background: #6c757d;">
                ‚¨ÖÔ∏è Back to Selection
            </button>
            <button onclick="resetTool()" style="background: #6c757d;">
                üîÑ Start Over with New File
            </button>
        </div>
    </div>

    <script>
        // Test that the page loads
        console.log('Page loaded successfully');
        
        let csvData = null;
        let parsedData = null;
        let buyerOrgs = {};
        let sellerOrgs = {};
        let selectedEntities = new Set();
        let currentAnalysis = {};
        let currentMode = null; // 'buyer' or 'seller'

        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                loadFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                loadFile(files[0]);
            }
        }

        function updateProgress(percent) {
            document.getElementById('progressFill').style.width = percent + '%';
        }

        async function loadFile(file) {
            if (!file.name.endsWith('.csv')) {
                alert('Please select a CSV file');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                csvData = e.target.result;
                document.getElementById('uploadSection').classList.add('hidden');
                document.getElementById('modeSection').classList.remove('hidden');
                
                // Process the CSV
                await processCSV();
            };
            
            reader.onerror = function(e) {
                alert('Error reading file. Please try again.');
            };
            
            reader.readAsText(file);
        }

        async function processCSV() {
            try {
                document.getElementById('loadingStatus').textContent = 'Parsing CSV file...';
                updateProgress(20);
                
                // Parse CSV
                const parsed = Papa.parse(csvData, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true
                });
                
                parsedData = parsed.data;
                updateProgress(40);
                
                document.getElementById('loadingStatus').textContent = 'Identifying buyers and sellers...';
                
                // Find all buyers
                const buyerRows = parsedData.filter(row => 
                    row.ProfileTypes && 
                    row.ProfileTypes.includes('Exchange Buyer') &&
                    row.DbaName
                );
                
                // Group buyers by organization
                buyerOrgs = {};
                buyerRows.forEach(row => {
                    if (!buyerOrgs[row.DbaName]) {
                        buyerOrgs[row.DbaName] = {
                            name: row.DbaName,
                            orgGuids: new Set(),
                            users: [],
                            organizationCounterparties: new Set()
                        };
                    }
                    buyerOrgs[row.DbaName].users.push(row);
                    if (row.OrganizationGuid) {
                        buyerOrgs[row.DbaName].orgGuids.add(row.OrganizationGuid);
                    }
                    if (row.OrganizationCounterparties) {
                        const orgCPs = row.OrganizationCounterparties.split('|');
                        orgCPs.forEach(cp => {
                            buyerOrgs[row.DbaName].organizationCounterparties.add(cp.trim());
                        });
                    }
                });
                
                updateProgress(60);
                
                // Find all sellers
                const sellerRows = parsedData.filter(row => 
                    row.ProfileTypes && 
                    row.ProfileTypes.includes('Exchange Seller') &&
                    row.DbaName
                );
                
                // Group sellers by organization
                sellerOrgs = {};
                sellerRows.forEach(row => {
                    if (!sellerOrgs[row.DbaName]) {
                        sellerOrgs[row.DbaName] = {
                            name: row.DbaName,
                            orgGuids: new Set(),
                            users: [],
                            hasPricingTiers: false,
                            pricingTierCounterparties: new Set(),
                            organizationCounterparties: new Set(),
                            pricingTiersByCounterparty: {} // Track which tiers each counterparty is in
                        };
                    }
                    sellerOrgs[row.DbaName].users.push(row);
                    
                    if (row.OrganizationGuid) {
                        sellerOrgs[row.DbaName].orgGuids.add(row.OrganizationGuid);
                    }
                    
                    if (row.PricingTier) {
                        sellerOrgs[row.DbaName].hasPricingTiers = true;
                    }
                    
                    if (row.PricingTiersCounterparties && row.PricingTier) {
                        const counterparties = row.PricingTiersCounterparties.split('|');
                        counterparties.forEach(cp => {
                            const cpTrimmed = cp.trim();
                            sellerOrgs[row.DbaName].pricingTierCounterparties.add(cpTrimmed);
                            
                            // Track which pricing tier this counterparty is in
                            if (!sellerOrgs[row.DbaName].pricingTiersByCounterparty[cpTrimmed]) {
                                sellerOrgs[row.DbaName].pricingTiersByCounterparty[cpTrimmed] = new Set();
                            }
                            sellerOrgs[row.DbaName].pricingTiersByCounterparty[cpTrimmed].add(row.PricingTier);
                        });
                    }
                    
                    if (row.OrganizationCounterparties) {
                        const orgCPs = row.OrganizationCounterparties.split('|');
                        orgCPs.forEach(cp => {
                            sellerOrgs[row.DbaName].organizationCounterparties.add(cp.trim());
                        });
                    }
                });
                
                updateProgress(80);
                
                // Show mode selection
                document.getElementById('modeSelectionArea').classList.remove('hidden');
                
                updateProgress(100);
                document.getElementById('loadingStatus').textContent = 'Found ' + Object.keys(buyerOrgs).length + ' buyer organizations and ' + Object.keys(sellerOrgs).length + ' seller organizations';
                document.getElementById('loadingStatus').className = 'status success';
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loadingStatus').textContent = 'Error: ' + error.message;
                document.getElementById('loadingStatus').className = 'status error';
            }
        }

        function selectMode(mode) {
            currentMode = mode;
            
            // Update UI to show selected mode
            document.querySelectorAll('.mode-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Show selection section
            setTimeout(() => {
                document.getElementById('modeSection').classList.add('hidden');
                document.getElementById('selectionSection').classList.remove('hidden');
                
                if (mode === 'buyer') {
                    document.getElementById('selectionTitle').textContent = 'üìã Select Buyers to Analyze';
                    displayBuyerSelection();
                } else {
                    document.getElementById('selectionTitle').textContent = 'üìã Select Sellers to Analyze';
                    displaySellerSelection();
                }
            }, 300);
        }

        function displayBuyerSelection() {
            const grid = document.getElementById('entityGrid');
            grid.innerHTML = '';
            
            Object.keys(buyerOrgs).sort().forEach(name => {
                createEntityItem(grid, name);
            });
        }

        function displaySellerSelection() {
            const grid = document.getElementById('entityGrid');
            grid.innerHTML = '';
            
            Object.keys(sellerOrgs).sort().forEach(name => {
                createEntityItem(grid, name);
            });
        }

        function createEntityItem(grid, name) {
            const div = document.createElement('div');
            div.className = 'entity-item';
            div.id = 'entity-' + name.replace(/[^a-zA-Z0-9]/g, '_');
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = name;
            checkbox.onchange = function() { toggleEntity(name); };
            
            const label = document.createElement('label');
            label.textContent = name;
            label.style.cursor = 'pointer';
            label.onclick = function() {
                checkbox.checked = !checkbox.checked;
                toggleEntity(name);
            };
            
            div.appendChild(checkbox);
            div.appendChild(label);
            grid.appendChild(div);
        }

        function toggleEntity(name) {
            const item = document.getElementById('entity-' + name.replace(/[^a-zA-Z0-9]/g, '_'));
            const checkbox = item.querySelector('input[type="checkbox"]');
            
            if (checkbox.checked) {
                selectedEntities.add(name);
                item.classList.add('selected');
            } else {
                selectedEntities.delete(name);
                item.classList.remove('selected');
            }
            
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const count = selectedEntities.size;
            const entityType = currentMode === 'buyer' ? 'buyer' : 'seller';
            document.getElementById('selectedCount').textContent = count + ' ' + entityType + (count !== 1 ? 's' : '') + ' selected';
            document.getElementById('analyzeBtn').disabled = count === 0;
        }

        function filterEntities() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const items = document.querySelectorAll('.entity-item');
            
            items.forEach(item => {
                const label = item.querySelector('label').textContent.toLowerCase();
                if (label.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function selectAll() {
            document.querySelectorAll('.entity-item input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
                selectedEntities.add(cb.value);
                cb.parentElement.classList.add('selected');
            });
            updateSelectedCount();
        }

        function selectNone() {
            document.querySelectorAll('.entity-item input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
                cb.parentElement.classList.remove('selected');
            });
            selectedEntities.clear();
            updateSelectedCount();
        }

        function selectFiltered() {
            document.querySelectorAll('.entity-item').forEach(item => {
                if (item.style.display !== 'none') {
                    const cb = item.querySelector('input[type="checkbox"]');
                    cb.checked = true;
                    selectedEntities.add(cb.value);
                    item.classList.add('selected');
                }
            });
            updateSelectedCount();
        }

        function analyzeSelected() {
            if (selectedEntities.size === 0) return;
            
            currentAnalysis = {};
            let totalCounterparties = 0;
            let totalActive = 0;
            
            if (currentMode === 'buyer') {
                // Analyze selected buyers
                selectedEntities.forEach(buyerName => {
                    const buyer = buyerOrgs[buyerName];
                    const buyerOrgGuids = Array.from(buyer.orgGuids);
                    
                    currentAnalysis[buyerName] = {
                        type: 'buyer',
                        counterpartyDetails: []
                    };
                    
                    // Find all sellers counterpartied to this buyer
                    Object.keys(sellerOrgs).forEach(sellerName => {
                        const seller = sellerOrgs[sellerName];
                        
                        let isCounterpartied = false;
                        for (let guid of buyerOrgGuids) {
                            if (seller.organizationCounterparties.has(guid)) {
                                isCounterpartied = true;
                                break;
                            }
                        }
                        
                        if (!isCounterpartied && seller.organizationCounterparties.has(buyerName)) {
                            isCounterpartied = true;
                        }
                        
                        if (isCounterpartied) {
                            totalCounterparties++;
                            
                            let statusDetail = '';
                            let pricingTiers = '';
                            
                            if (seller.pricingTierCounterparties.has(buyerName)) {
                                statusDetail = 'Active - Has buyer in pricing tiers';
                                totalActive++;
                                // Get the pricing tiers this buyer is in
                                if (seller.pricingTiersByCounterparty[buyerName]) {
                                    pricingTiers = Array.from(seller.pricingTiersByCounterparty[buyerName]).join('|');
                                }
                            } else if (!seller.hasPricingTiers) {
                                statusDetail = 'Active - No tiers configured (using defaults)';
                                totalActive++;
                                pricingTiers = 'N/A - No tiers configured';
                            } else {
                                statusDetail = 'Not Active';
                                pricingTiers = '';
                            }
                            
                            currentAnalysis[buyerName].counterpartyDetails.push({
                                name: sellerName,
                                status: statusDetail,
                                pricingTiers: pricingTiers
                            });
                        }
                    });
                });
            } else {
                // Analyze selected sellers
                selectedEntities.forEach(sellerName => {
                    const seller = sellerOrgs[sellerName];
                    const sellerOrgGuids = Array.from(seller.orgGuids);
                    
                    currentAnalysis[sellerName] = {
                        type: 'seller',
                        counterpartyDetails: []
                    };
                    
                    // Find all buyers counterpartied to this seller
                    Object.keys(buyerOrgs).forEach(buyerName => {
                        const buyer = buyerOrgs[buyerName];
                        
                        let isCounterpartied = false;
                        
                        // Check if seller's org GUID is in buyer's organization counterparties
                        for (let guid of sellerOrgGuids) {
                            if (buyer.organizationCounterparties.has(guid)) {
                                isCounterpartied = true;
                                break;
                            }
                        }
                        
                        // Check if buyer's org GUID is in seller's organization counterparties
                        if (!isCounterpartied) {
                            for (let buyerGuid of buyer.orgGuids) {
                                if (seller.organizationCounterparties.has(buyerGuid)) {
                                    isCounterpartied = true;
                                    break;
                                }
                            }
                        }
                        
                        // Also check by name
                        if (!isCounterpartied && seller.organizationCounterparties.has(buyerName)) {
                            isCounterpartied = true;
                        }
                        
                        if (isCounterpartied) {
                            totalCounterparties++;
                            
                            let statusDetail = '';
                            let pricingTiers = '';
                            
                            if (seller.pricingTierCounterparties.has(buyerName)) {
                                statusDetail = 'Active - Buyer enabled in pricing tiers';
                                totalActive++;
                                // Get the pricing tiers this buyer is in
                                if (seller.pricingTiersByCounterparty[buyerName]) {
                                    pricingTiers = Array.from(seller.pricingTiersByCounterparty[buyerName]).join('|');
                                }
                            } else if (!seller.hasPricingTiers) {
                                statusDetail = 'Active - No tiers configured (all buyers active)';
                                totalActive++;
                                pricingTiers = 'N/A - No tiers configured';
                            } else {
                                statusDetail = 'Not Active - Buyer not in pricing tiers';
                                pricingTiers = '';
                            }
                            
                            currentAnalysis[sellerName].counterpartyDetails.push({
                                name: buyerName,
                                status: statusDetail,
                                pricingTiers: pricingTiers
                            });
                        }
                    });
                });
            }
            
            displayResults(totalCounterparties, totalActive);
        }

        function displayResults(totalCounterparties, totalActive) {
            document.getElementById('selectionSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
            
            // Update stats based on mode
            if (currentMode === 'buyer') {
                document.getElementById('stat1Label').textContent = 'Buyers Analyzed';
                document.getElementById('stat2Label').textContent = 'Total Sellers';
                document.getElementById('stat3Label').textContent = 'Active Sellers';
            } else {
                document.getElementById('stat1Label').textContent = 'Sellers Analyzed';
                document.getElementById('stat2Label').textContent = 'Total Buyers';
                document.getElementById('stat3Label').textContent = 'Active Buyers';
            }
            
            document.getElementById('stat1Number').textContent = selectedEntities.size;
            document.getElementById('stat2Number').textContent = totalCounterparties;
            document.getElementById('stat3Number').textContent = totalActive;
            const percent = totalCounterparties > 0 ? Math.round((totalActive / totalCounterparties) * 100) : 0;
            document.getElementById('stat4Number').textContent = percent + '%';
            
            // Generate preview
            const preview = document.getElementById('reportPreview');
            preview.innerHTML = '';
            
            Object.keys(currentAnalysis).forEach(entityName => {
                const section = document.createElement('div');
                section.className = 'report-section';
                
                const title = document.createElement('h3');
                title.textContent = entityName;
                section.appendChild(title);
                
                const activeItems = currentAnalysis[entityName].counterpartyDetails.filter(cp => cp.status.startsWith('Active'));
                
                const stats = document.createElement('p');
                const counterpartyType = currentMode === 'buyer' ? 'Sellers' : 'Buyers';
                stats.innerHTML = '<strong>Total ' + counterpartyType + ':</strong> ' + 
                    currentAnalysis[entityName].counterpartyDetails.length + 
                    ' | <strong>Active:</strong> ' + activeItems.length;
                section.appendChild(stats);
                
                if (currentAnalysis[entityName].counterpartyDetails.length > 0) {
                    const listTitle = document.createElement('p');
                    listTitle.innerHTML = '<strong>Counterparty Details:</strong>';
                    section.appendChild(listTitle);
                    
                    const entityList = document.createElement('div');
                    entityList.className = 'entity-list';
                    
                    currentAnalysis[entityName].counterpartyDetails.slice(0, 10).forEach(cp => {
                        const card = document.createElement('div');
                        card.className = cp.status.startsWith('Active') ? 'entity-card active' : 'entity-card inactive';
                        let cardHtml = '<strong>' + cp.name + '</strong><br><small>' + cp.status + '</small>';
                        if (cp.pricingTiers) {
                            cardHtml += '<br><small style="color: #007bff;">Tiers: ' + cp.pricingTiers + '</small>';
                        }
                        card.innerHTML = cardHtml;
                        entityList.appendChild(card);
                    });
                    
                    if (currentAnalysis[entityName].counterpartyDetails.length > 10) {
                        const more = document.createElement('div');
                        more.className = 'entity-card';
                        more.textContent = '... and ' + (currentAnalysis[entityName].counterpartyDetails.length - 10) + ' more';
                        more.style.fontStyle = 'italic';
                        entityList.appendChild(more);
                    }
                    
                    section.appendChild(entityList);
                }
                
                preview.appendChild(section);
            });
        }

        function downloadExcel() {
            const wb = XLSX.utils.book_new();
            
            Object.keys(currentAnalysis).forEach(entityName => {
                const analysis = currentAnalysis[entityName];
                
                const headerType = currentMode === 'buyer' ? 'Counterpartied Seller' : 'Counterpartied Buyer';
                const sheetData = [[headerType, 'Activity Status', 'Pricing Tiers']];
                
                analysis.counterpartyDetails.forEach(cp => {
                    sheetData.push([cp.name, cp.status, cp.pricingTiers || '']);
                });
                
                const ws = XLSX.utils.aoa_to_sheet(sheetData);
                
                ws['!cols'] = [{ wch: 40 }, { wch: 50 }, { wch: 40 }];
                
                let sheetName = entityName.substring(0, 31);
                sheetName = sheetName.replace(/[\/\\\?\*\[\]]/g, '_');
                
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            });
            
            const entityType = currentMode === 'buyer' ? 'Buyer' : 'Seller';
            const fileName = selectedEntities.size === 1 
                ? Array.from(selectedEntities)[0] + '_' + entityType + '_Analysis.xlsx'
                : entityType + '_Analysis_' + selectedEntities.size + '_Items.xlsx';
            
            XLSX.writeFile(wb, fileName);
        }

        function backToModeSelection() {
            selectedEntities.clear();
            currentMode = null;
            document.getElementById('selectionSection').classList.add('hidden');
            document.getElementById('modeSection').classList.remove('hidden');
            document.getElementById('searchBox').value = '';
            document.querySelectorAll('.mode-card').forEach(card => {
                card.classList.remove('selected');
            });
        }

        function backToSelection() {
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('selectionSection').classList.remove('hidden');
        }

        function resetTool() {
            csvData = null;
            parsedData = null;
            buyerOrgs = {};
            sellerOrgs = {};
            selectedEntities.clear();
            currentAnalysis = {};
            currentMode = null;
            
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('modeSection').classList.add('hidden');
            document.getElementById('selectionSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('fileInput').value = '';
            document.getElementById('searchBox').value = '';
            updateProgress(0);
            
            document.querySelectorAll('.mode-card').forEach(card => {
                card.classList.remove('selected');
            });
        }
    </script>
</body>
</html>
